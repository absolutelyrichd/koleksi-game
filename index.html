<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Koleksi Game</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        body {
            background-color: #f0f2f5;
            font-family: 'Poppins', sans-serif;
        }
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .login-container h1 {
            font-weight: 600;
        }
        .main-dashboard {
            display: none; /* Disembunyikan secara default */
        }
        .nav-link {
            cursor: pointer;
            color: #495057;
        }
        .nav-link.active {
            font-weight: 500;
            color: #4a5568;
            border-bottom: 2px solid #667eea;
        }
        .stat-card {
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .form-label {
            font-weight: 500;
        }
        .material-symbols-outlined {
            vertical-align: bottom;
            font-size: 1.2em;
            margin-right: 4px;
        }
        .btn .material-symbols-outlined {
             margin-right: 0;
        }
    </style>
</head>
<body>

    <!-- Halaman Login -->
    <div id="login-screen" class="login-container text-center p-3">
        <h1 class="mb-3">ðŸŽ® Dashboard Koleksi Game</h1>
        <p class="lead mb-4">Kelola semua game favorit Anda di satu tempat.</p>
        <button id="login-btn" class="btn btn-light btn-lg shadow-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-google me-2" viewBox="0 0 16 16" style="vertical-align: text-bottom;">
                <path d="M15.545 6.558a9.42 9.42 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.689 7.689 0 0 1 5.352 2.082l-2.284 2.284A4.347 4.347 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.25C2.893 7.087 2.82 7.545 2.82 8s.073.913.256 1.484c.632 1.842 2.405 3.25 4.492 3.25 1.133 0 2.14-.37 2.932-1.012l.002-.002 2.284 2.284A7.952 7.952 0 0 1 8 16c-2.158 0-3.978-.708-5.352-1.89C1.226 12.783.5 10.592.5 8s.726-4.783 2.148-6.11A7.95 7.95 0 0 1 8 0c2.434 0 4.492.87 5.885 2.384l-2.284 2.284A4.347 4.347 0 0 0 8 4.834c-1.133 0-2.14.37-2.932 1.012l-.002.002C4.13 6.913 3.5 8.958 3.5 10.5c0 1.542.63 3.587 1.58 4.492l.002.002a4.347 4.347 0 0 0 2.92 1.012c1.842 0 3.25-.632 4.492-2.405.958-.857 1.58-2.434 1.58-4.492a9.42 9.42 0 0 1-.139-1.626H8V6.558h7.545z"/>
            </svg>
            Login dengan Google
        </button>
    </div>

    <!-- Dashboard Utama -->
    <div id="main-dashboard" class="main-dashboard">
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold" href="#">ðŸŽ® Koleksi Game</a>
                <div class="d-flex align-items-center">
                    <span id="user-display" class="navbar-text me-3"></span>
                    <button id="logout-btn" class="btn btn-outline-danger">Logout</button>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            <!-- Navigasi Tab -->
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-pane" type="button" role="tab">
                        <span class="material-symbols-outlined">list</span>Daftar Game
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats-pane" type="button" role="tab">
                        <span class="material-symbols-outlined">pie_chart</span>Statistik
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="bulk-tab" data-bs-toggle="tab" data-bs-target="#bulk-pane" type="button" role="tab">
                        <span class="material-symbols-outlined">checklist</span>Aksi Masal
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-pane" type="button" role="tab">
                        <span class="material-symbols-outlined">database</span>Manajemen Data
                    </button>
                </li>
            </ul>

            <!-- Isi Tab -->
            <div class="tab-content" id="myTabContent">
                <!-- Tab 1: Daftar Game -->
                <div class="tab-pane fade show active" id="list-pane" role="tabpanel" tabindex="0">
                    <div class="card mt-3 border-0 shadow-sm">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Koleksi Game Saya</h5>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#game-modal" id="add-game-btn">
                                <span class="material-symbols-outlined">add</span> Tambah Game
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead>
                                        <tr>
                                            <th>Judul Game</th>
                                            <th>Platform</th>
                                            <th>Lokasi</th>
                                            <th>Status</th>
                                            <th class="text-end">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="game-list-body">
                                        <!-- Data game akan dimuat di sini -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 2: Statistik -->
                <div class="tab-pane fade" id="stats-pane" role="tabpanel" tabindex="0">
                    <div class="row mt-3 g-4">
                        <div class="col-md-4">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-white text-center fw-bold">Game per Platform</div>
                                <div class="card-body stat-card">
                                    <canvas id="platform-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                             <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-white text-center fw-bold">Game per Lokasi</div>
                                <div class="card-body stat-card">
                                    <canvas id="location-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                             <div class="card border-0 shadow-sm h-100">
                                <div class="card-header bg-white text-center fw-bold">Game per Status</div>
                                <div class="card-body stat-card">
                                    <canvas id="status-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 3: Aksi Masal -->
                <div class="tab-pane fade" id="bulk-pane" role="tabpanel" tabindex="0">
                    <div class="card mt-3 border-0 shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">Filter dan Aksi Masal</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 mb-3 p-3 bg-light rounded border">
                                <div class="col-md-3">
                                    <label for="filter-platform" class="form-label">Platform</label>
                                    <select id="filter-platform" class="form-select">
                                        <option value="">Semua</option>
                                        <option>Steam</option><option>Epic</option><option>GOG</option><option>PCSX</option><option>Crack</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="filter-location" class="form-label">Lokasi</label>
                                    <select id="filter-location" class="form-select">
                                        <option value="">Semua</option>
                                        <option>HDD Eksternal 2TB</option><option>HDD Eksternal 4TB</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="filter-status" class="form-label">Status</label>
                                    <select id="filter-status" class="form-select">
                                        <option value="">Semua</option>
                                        <option>Dimainkan</option><option>Belum dimainkan</option>
                                    </select>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button id="reset-filter-btn" class="btn btn-secondary w-100">Reset Filter</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <button id="bulk-delete-btn" class="btn btn-danger">
                                    <span class="material-symbols-outlined">delete_sweep</span> Hapus yang Dipilih
                                </button>
                                <button id="bulk-edit-btn" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#bulk-edit-modal">
                                    <span class="material-symbols-outlined">edit</span> Edit yang Dipilih
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" id="select-all-checkbox" class="form-check-input"></th>
                                            <th>Judul Game</th>
                                            <th>Platform</th>
                                            <th>Lokasi</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bulk-list-body">
                                        <!-- Data game untuk aksi masal dimuat di sini -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 4: Manajemen Data -->
                <div class="tab-pane fade" id="data-pane" role="tabpanel" tabindex="0">
                     <div class="row mt-3 g-4">
                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0">Unduh Data (Backup)</h5>
                                </div>
                                <div class="card-body text-center d-flex flex-column justify-content-center">
                                    <p>Simpan seluruh koleksi game Anda sebagai file JSON.</p>
                                    <button id="download-json-btn" class="btn btn-primary">
                                        <span class="material-symbols-outlined">download</span> Unduh JSON
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100 border-0 shadow-sm">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0">Muat Data (Restore)</h5>
                                </div>
                                <div class="card-body text-center d-flex flex-column justify-content-center">
                                    <p>Ganti data saat ini dengan data dari file JSON. <strong>Aksi ini tidak dapat dibatalkan.</strong></p>
                                    <input type="file" id="upload-json-input" class="form-control mb-3" accept=".json">
                                    <button id="upload-json-btn" class="btn btn-warning">
                                        <span class="material-symbols-outlined">upload</span> Muat JSON ke Firebase
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tambah/Edit Game -->
    <div class="modal fade" id="game-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="game-modal-title">Tambah Game Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="game-form">
                        <input type="hidden" id="game-id">
                        <div class="mb-3">
                            <label for="game-title" class="form-label">Judul Game</label>
                            <input type="text" class="form-control" id="game-title" required>
                        </div>
                        <div class="mb-3">
                            <label for="game-platform" class="form-label">Platform</label>
                            <select class="form-select" id="game-platform" required>
                                <option>Steam</option><option>Epic</option><option>GOG</option><option>PCSX</option><option>Crack</option>
                            </select>
                        </div>
                         <div class="mb-3">
                            <label for="game-location" class="form-label">Lokasi Penyimpanan</label>
                            <select class="form-select" id="game-location" required>
                                <option>HDD Eksternal 2TB</option><option>HDD Eksternal 4TB</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="game-status" class="form-label">Status</label>
                            <select class="form-select" id="game-status" required>
                                <option>Belum dimainkan</option><option>Dimainkan</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="save-game-btn">Simpan</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Edit Masal -->
    <div class="modal fade" id="bulk-edit-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Game yang Dipilih</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Pilih properti yang ingin diubah untuk semua game yang dipilih.</p>
                    <div class="mb-3">
                        <label for="bulk-edit-platform" class="form-label">Ubah Platform ke:</label>
                        <select id="bulk-edit-platform" class="form-select">
                            <option value="">-- Jangan Ubah --</option>
                            <option>Steam</option><option>Epic</option><option>GOG</option><option>PCSX</option><option>Crack</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="bulk-edit-location" class="form-label">Ubah Lokasi ke:</label>
                        <select id="bulk-edit-location" class="form-select">
                            <option value="">-- Jangan Ubah --</option>
                            <option>HDD Eksternal 2TB</option><option>HDD Eksternal 4TB</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="bulk-edit-status" class="form-label">Ubah Status ke:</label>
                        <select id="bulk-edit-status" class="form-select">
                            <option value="">-- Jangan Ubah --</option>
                            <option>Dimainkan</option><option>Belum dimainkan</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="apply-bulk-edit-btn">Terapkan Perubahan</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- Bootstrap & Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Konfigurasi Firebase Anda (diperbaiki)
        const firebaseConfig = {
            apiKey: "AIzaSyAzJTL179V9bT-DfefZq9gcG8Tz88VzLmQ",
            authDomain: "koleksi-game.firebaseapp.com",
            databaseURL: "https://koleksi-game-default-rtdb.firebaseio.com", // Ditambahkan untuk keandalan
            projectId: "koleksi-game",
            storageBucket: "koleksi-game.appspot.com",
            messagingSenderId: "222959670551",
            appId: "1:222959670551:web:048b1e2c4ef16b7bd31352",
            measurementId: "G-BYYCM7R4M8"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const provider = new firebase.auth.GoogleAuthProvider();

        // Variabel Global
        let currentUser = null;
        let gameData = {}; // Satu sumber data utama dari Firebase
        let chartInstances = {}; // Menyimpan semua instance chart
        const gameModal = new bootstrap.Modal(document.getElementById('game-modal'));
        const bulkEditModal = new bootstrap.Modal(document.getElementById('bulk-edit-modal'));

        // Elemen DOM
        const loginScreen = document.getElementById('login-screen');
        const mainDashboard = document.getElementById('main-dashboard');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userDisplay = document.getElementById('user-display');
        
        // Pemantau status Autentikasi
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loginScreen.style.display = 'none';
                mainDashboard.style.display = 'block';
                userDisplay.textContent = `Halo, ${user.displayName.split(' ')[0]}`;
                loadGames();
            } else {
                currentUser = null;
                loginScreen.style.display = 'flex';
                mainDashboard.style.display = 'none';
                gameData = {};
                renderLists({});
                updateStatistics({});
            }
        });

        // Fungsi Login & Logout
        loginBtn.addEventListener('click', () => auth.signInWithPopup(provider));
        logoutBtn.addEventListener('click', () => auth.signOut());

        // Memuat data game dari Firebase
        function loadGames() {
            if (!currentUser) return;
            const gamesRef = database.ref('games/' + currentUser.uid);
            gamesRef.on('value', (snapshot) => {
                gameData = snapshot.val() || {};
                applyFilters(); // Terapkan filter saat ini ke data baru
                updateStatistics(gameData); // Perbarui statistik dengan data lengkap
            });
        }
        
        // Fungsi render terpusat untuk semua list
        function renderLists(dataToRender) {
            const gameListBody = document.getElementById('game-list-body');
            const bulkListBody = document.getElementById('bulk-list-body');
            gameListBody.innerHTML = '';
            bulkListBody.innerHTML = '';

            if (Object.keys(dataToRender).length === 0) {
                 const noDataRow = '<tr><td colspan="5" class="text-center text-muted fst-italic py-4">Tidak ada data untuk ditampilkan.</td></tr>';
                 gameListBody.innerHTML = noDataRow;
                 bulkListBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted fst-italic py-4">Tidak ada data yang cocok dengan filter.</td></tr>';
                 return;
            }

            for (const gameId in dataToRender) {
                const game = dataToRender[gameId];
                const listRow = `
                    <tr>
                        <td>${game.title}</td>
                        <td>${game.platform}</td>
                        <td>${game.location}</td>
                        <td><span class="badge bg-${game.status === 'Dimainkan' ? 'success' : 'secondary'}">${game.status}</span></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-warning edit-btn" data-id="${gameId}" title="Edit">
                                <span class="material-symbols-outlined">edit</span>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${gameId}" title="Hapus">
                                <span class="material-symbols-outlined">delete</span>
                            </button>
                        </td>
                    </tr>`;
                gameListBody.innerHTML += listRow;

                const bulkRow = `
                    <tr>
                        <td><input type="checkbox" class="form-check-input bulk-checkbox" data-id="${gameId}"></td>
                        <td>${game.title}</td>
                        <td>${game.platform}</td>
                        <td>${game.location}</td>
                        <td>${game.status}</td>
                    </tr>`;
                bulkListBody.innerHTML += bulkRow;
            }
        }

        // Fungsi untuk menerapkan filter dan me-render ulang list
        function applyFilters() {
            const platform = document.getElementById('filter-platform').value;
            const location = document.getElementById('filter-location').value;
            const status = document.getElementById('filter-status').value;

            if (!platform && !location && !status) {
                renderLists(gameData); // Jika tidak ada filter, tampilkan semua
                return;
            }
            
            const filteredData = Object.fromEntries(
                Object.entries(gameData).filter(([id, game]) => {
                    const platformMatch = !platform || game.platform === platform;
                    const locationMatch = !location || game.location === location;
                    const statusMatch = !status || game.status === status;
                    return platformMatch && locationMatch && statusMatch;
                })
            );
            renderLists(filteredData);
        }

        // CRUD Actions
        document.getElementById('save-game-btn').addEventListener('click', () => {
            const id = document.getElementById('game-id').value;
            const title = document.getElementById('game-title').value.trim();
            if (!title) {
                alert('Judul game tidak boleh kosong!');
                return;
            }
            
            const game = {
                title: title,
                platform: document.getElementById('game-platform').value,
                location: document.getElementById('game-location').value,
                status: document.getElementById('game-status').value
            };
            
            const gamesRef = database.ref('games/' + currentUser.uid);
            const promise = id ? gamesRef.child(id).update(game) : gamesRef.push(game);

            promise
                .then(() => gameModal.hide())
                .catch(error => {
                    console.error("Firebase save/update error:", error);
                    alert("Gagal menyimpan data: " + error.message);
                });
        });

        document.getElementById('list-pane').addEventListener('click', e => {
            const editBtn = e.target.closest('.edit-btn');
            if (editBtn) {
                const gameId = editBtn.dataset.id;
                const game = gameData[gameId];
                document.getElementById('game-modal-title').textContent = 'Edit Game';
                document.getElementById('game-id').value = gameId;
                document.getElementById('game-title').value = game.title;
                document.getElementById('game-platform').value = game.platform;
                document.getElementById('game-location').value = game.location;
                document.getElementById('game-status').value = game.status;
                gameModal.show();
            }
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                const gameId = deleteBtn.dataset.id;
                if (confirm(`Apakah Anda yakin ingin menghapus game "${gameData[gameId].title}"?`)) {
                    database.ref('games/' + currentUser.uid + '/' + gameId).remove();
                }
            }
        });

        document.getElementById('add-game-btn').addEventListener('click', () => {
            document.getElementById('game-modal-title').textContent = 'Tambah Game Baru';
            document.getElementById('game-form').reset();
            document.getElementById('game-id').value = '';
        });

        // Tab Statistik
        function updateStatistics(data) {
            const stats = { platform: {}, location: {}, status: {} };
            for (const id in data) {
                const game = data[id];
                stats.platform[game.platform] = (stats.platform[game.platform] || 0) + 1;
                stats.location[game.location] = (stats.location[game.location] || 0) + 1;
                stats.status[game.status] = (stats.status[game.status] || 0) + 1;
            }
            createOrUpdateChart('platform-chart', 'pie', stats.platform);
            createOrUpdateChart('location-chart', 'doughnut', stats.location);
            createOrUpdateChart('status-chart', 'pie', stats.status);
        }

        function createOrUpdateChart(canvasId, type, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (chartInstances[canvasId]) {
                 chartInstances[canvasId].destroy();
            }
            chartInstances[canvasId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [
                            '#7B68EE', '#4169E1', '#00BFFF', '#20B2AA', '#3CB371', '#FFD700', '#FFA07A', '#F08080'
                        ],
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }
        
        document.getElementById('stats-tab').addEventListener('click', () => updateStatistics(gameData));
        
        // Tab Aksi Masal
        ['filter-platform', 'filter-location', 'filter-status'].forEach(id => {
            document.getElementById(id).addEventListener('change', applyFilters);
        });
        document.getElementById('reset-filter-btn').addEventListener('click', () => {
            document.getElementById('filter-platform').value = '';
            document.getElementById('filter-location').value = '';
            document.getElementById('filter-status').value = '';
            applyFilters();
        });
        
        document.getElementById('select-all-checkbox').addEventListener('change', function() {
            document.querySelectorAll('.bulk-checkbox').forEach(cb => { cb.checked = this.checked; });
        });

        function getSelectedGameIds() {
            return Array.from(document.querySelectorAll('.bulk-checkbox:checked')).map(cb => cb.dataset.id);
        }

        document.getElementById('bulk-delete-btn').addEventListener('click', () => {
            const selectedIds = getSelectedGameIds();
            if (selectedIds.length === 0) {
                alert('Pilih setidaknya satu game untuk dihapus.');
                return;
            }
            if (confirm(`Anda yakin ingin menghapus ${selectedIds.length} game yang dipilih?`)) {
                const updates = {};
                selectedIds.forEach(id => {
                    updates['/games/' + currentUser.uid + '/' + id] = null;
                });
                database.ref().update(updates);
            }
        });
        
        document.getElementById('apply-bulk-edit-btn').addEventListener('click', () => {
             const selectedIds = getSelectedGameIds();
             if (selectedIds.length === 0) {
                alert('Pilih setidaknya satu game untuk diedit.');
                return;
            }
            const updates = {};
            const newPlatform = document.getElementById('bulk-edit-platform').value;
            const newLocation = document.getElementById('bulk-edit-location').value;
            const newStatus = document.getElementById('bulk-edit-status').value;
            if (!newPlatform && !newLocation && !newStatus) {
                alert('Pilih setidaknya satu properti untuk diubah.');
                return;
            }
            selectedIds.forEach(id => {
                if (newPlatform) updates[`/games/${currentUser.uid}/${id}/platform`] = newPlatform;
                if (newLocation) updates[`/games/${currentUser.uid}/${id}/location`] = newLocation;
                if (newStatus) updates[`/games/${currentUser.uid}/${id}/status`] = newStatus;
            });

            database.ref().update(updates)
                .then(() => {
                    bulkEditModal.hide();
                    alert(`${selectedIds.length} game berhasil diupdate.`);
                })
                .catch(err => alert('Gagal mengupdate: ' + err.message));
        });

        // Tab Manajemen Data
        document.getElementById('download-json-btn').addEventListener('click', () => {
            if (Object.keys(gameData).length === 0) {
                alert('Tidak ada data untuk diunduh.');
                return;
            }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(gameData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `koleksi_game_${new Date().toISOString().split('T')[0]}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        });

        document.getElementById('upload-json-btn').addEventListener('click', () => {
            const fileInput = document.getElementById('upload-json-input');
            if (fileInput.files.length === 0) {
                alert('Silakan pilih file JSON terlebih dahulu.');
                return;
            }
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(event) {
                try {
                    const newGameData = JSON.parse(event.target.result);
                    if (confirm("Anda yakin ingin MENGGANTI seluruh data koleksi game Anda dengan data dari file ini? Aksi ini tidak bisa dibatalkan.")) {
                        database.ref('games/' + currentUser.uid).set(newGameData)
                            .then(() => alert('Data berhasil dimuat dari JSON!'))
                            .catch(error => alert('Gagal memuat data: ' + error.message));
                    }
                } catch (e) {
                    alert('Error: File JSON tidak valid. ' + e.message);
                }
            };
            reader.readAsText(file);
        });
    </script>
</body>
</html>
