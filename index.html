<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koleksi Game</title>
    <!-- Memuat Tailwind CSS dari CDN untuk styling yang cepat dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Chart.js untuk diagram lingkaran -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Mengatur font default menjadi Inter dan mengecilkan ukurannya */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Warna latar belakang abu-abu muda */
            font-size: 0.9em; /* Mengurangi ukuran font keseluruhan satu tingkat */
        }
        /* Styling untuk scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* Memastikan canvas responsif */
        canvas {
            max-width: 100%;
            height: auto;
        }
        /* Styling untuk tab aktif */
        .tab-button.active {
            background-color: #4c51bf; /* indigo-700 */
            color: white;
            border-bottom-color: #4c51bf;
            border-bottom-width: 2px;
        }
        /* Basic modal styling */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 81x;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8 lg:p-10 bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="container mx-auto bg-white rounded-lg shadow-xl p-6 md:p-8 lg:p-10 max-w-4xl w-full">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-6 text-center">Koleksi Game</h1>

        <!-- Display User ID -->
        <p id="userIdDisplay" class="text-sm text-gray-500 text-center mb-4">Memuat ID Pengguna...</p>

        <!-- Authentication Buttons -->
        <div class="flex justify-center mb-6 space-x-4">
            <button id="githubSignInButton" class="bg-gray-800 hover:bg-gray-900 text-white font-bold py-2 px-6 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                Login dengan GitHub
            </button>
            <button id="signOutButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105 hidden">
                Sign Out
            </button>
        </div>

        <!-- Form untuk Menambahkan/Mengedit Game (Dipindahkan di luar tab) -->
        <div class="mb-8 p-6 bg-blue-50 rounded-lg shadow-md">
            <h2 id="formTitle" class="text-xl font-semibold text-blue-800 mb-4"> </h2>
            <form id="gameForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="gameTitle" class="block text-sm font-medium text-gray-700 mb-1">Judul Game</label>
                    <input type="text" id="gameTitle" placeholder="Misal: Cyberpunk 2077" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                </div>
                <div>
                    <label for="gamePlatform" class="block text-sm font-medium text-gray-700 mb-1">Platform</label>
                    <select id="gamePlatform"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div id="manualPlatformInputContainer" class="hidden">
                    <label for="manualGamePlatform" class="block text-sm font-medium text-gray-700 mb-1">Lainnya</label>
                    <input type="text" id="manualGamePlatform" placeholder="Masukkan nama platform"
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                </div>
                <div>
                    <label for="gameStore" class="block text-sm font-medium text-gray-700 mb-1">Platform Digital</label>
                    <select id="gameStore"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div id="manualStoreInputContainer" class="hidden">
                    <label for="manualGameStore" class="block text-sm font-medium text-gray-700 mb-1">Lainnya</label>
                    <input type="text" id="manualGameStore" placeholder="Masukkan nama toko"
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                </div>
                <div>
                    <label for="gameStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="gameStatus"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label for="lokasiMentahan" class="block text-sm font-medium text-gray-700 mb-1">Mentahan (Opsional)</label>
                    <select id="lokasiMentahan"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div id="manualLokasiMentahanInputContainer" class="hidden md:col-span-2">
                    <label for="manualLokasiMentahan" class="block text-sm font-medium text-gray-700 mb-1">Lainnya</label>
                    <input type="text" id="manualLokasiMentahan" placeholder="Masukkan nama lokasi"
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                </div>
                <div class="md:col-span-2 flex justify-end space-x-3">
                    <button type="button" id="cancelEditButton"
                            class="hidden bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                        Batal Edit
                    </button>
                    <button type="submit" id="submitButton"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                        Tambah Game
                    </button>
                </div>
            </form>
        </div>

        <!-- Navigasi Tab (Dipindahkan di bawah form) -->
        <div class="flex border-b border-gray-200 mb-6">
            <button class="tab-button active px-4 py-2 text-lg font-medium text-gray-700 hover:text-indigo-700 transition duration-300 ease-in-out" data-tab="game-list">Koleksi Game</button>
            <button class="tab-button px-4 py-2 text-lg font-medium text-gray-700 hover:text-indigo-700 transition duration-300 ease-in-out" data-tab="statistics">Statistik</button>
            <button class="tab-button px-4 py-2 text-lg font-medium text-gray-700 hover:text-indigo-700 transition duration-300 ease-in-out" data-tab="data-management">Data</button>
        </div>

        <!-- Konten Tab -->
        <div id="game-list" class="tab-content">
            <!-- Filter, Pencarian, dan Pengurutan -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Filter, Pencarian & Pengurutan</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label for="searchGame" class="block text-sm font-medium text-gray-700 mb-1">Cari Game</label>
                        <input type="text" id="searchGame" placeholder="Cari berdasarkan judul, platform, atau toko..."
                               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 shadow-sm">
                    </div>
                    <div>
                        <label for="filterStatus" class="block text-sm font-medium text-gray-700 mb-1">Filter Status</label>
                        <select id="filterStatus"
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 shadow-sm">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="filterPlatform" class="block text-sm font-medium text-gray-700 mb-1">Filter Platform</label>
                        <select id="filterPlatform"
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 shadow-sm">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="filterLokasiMentahan" class="block text-sm font-medium text-gray-700 mb-1">Filter Mentahan</label>
                        <select id="filterLokasiMentahan"
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 shadow-sm">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="sortGames" class="block text-sm font-medium text-gray-700 mb-1">Urutkan Berdasarkan</label>
                        <select id="sortGames"
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 shadow-sm">
                            <option value="title-asc">Judul (A-Z)</option>
                            <option value="title-desc">Judul (Z-A)</option>
                            <option value="platform-asc">Platform (A-Z)</option>
                            <option value="status-asc">Status (A-Z)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Daftar Koleksi Game -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Daftar Game</h2>
                <div id="gameList" class="space-y-4">
                    <!-- Daftar game akan dirender di sini oleh JavaScript -->
                    <p id="noGamesMessage" class="text-gray-500 text-center hidden">Belum ada game dalam koleksi Anda. Tambahkan game baru di atas!</p>
                </div>
                <div id="paginationControls" class="flex justify-center items-center mt-6 space-x-2">
                    <!-- Kontrol paginasi akan dirender di sini oleh JavaScript -->
                </div>
            </div>
        </div>

        <div id="statistics" class="tab-content hidden">
            <!-- Statistik Koleksi -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-gray-700 mb-3">Statistik Koleksi</h2>
                <div id="statistics-charts" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div id="gameStatisticsSection" class="p-4 bg-cyan-100 rounded-lg shadow-md flex flex-col items-center">
                        <h3 class="text-base font-semibold text-cyan-800 mb-2">Statistik Game (Berdasarkan Status)</h3>
                        <div class="relative w-full h-64">
                            <canvas id="gameStatusChart"></canvas>
                        </div>
                        <div id="gameStatusLegend" class="mt-4 text-xs"></div>
                    </div>
                    <div id="platformStatisticsSection" class="p-4 bg-indigo-100 rounded-lg shadow-md flex flex-col items-center">
                        <h3 class="text-base font-semibold text-indigo-800 mb-2">Statistik Platform</h3>
                        <div class="relative w-full h-64">
                            <canvas id="platformChart"></canvas>
                        </div>
                        <div id="platformLegend" class="mt-4 text-xs"></div>
                    </div>
                    <div id="lokasiMentahanStatisticsSection" class="p-4 bg-teal-100 rounded-lg shadow-md flex flex-col items-center">
                        <h3 class="text-base font-semibold text-teal-800 mb-2">Statistik Lokasi</h3>
                        <div class="relative w-full h-64">
                            <canvas id="lokasiMentahanChart"></canvas>
                        </div>
                        <div id="lokasiMentahanLegend" class="mt-4 text-xs"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="data-management" class="tab-content hidden">
            <!-- Tombol untuk Simpan/Muat Data -->
            <div class="mb-8 p-4 bg-purple-50 rounded-lg shadow-md flex flex-wrap justify-center gap-4">
                <h2 class="text-xl font-semibold text-purple-800 w-full text-center mb-3"></h2>
                <button id="exportDataButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                    Ekspor Data (JSON)
                </button>
                <input type="file" id="importFileInput" accept=".json" class="hidden">
                <button id="importDataButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                    Impor Data (JSON)
                </button>
                <div class="flex items-center justify-center gap-4 w-full mt-4">
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="autoDownloadToggle" class="form-checkbox h-5 w-5 text-blue-600 rounded-md">
                        <label for="autoDownloadToggle" class="text-gray-700 font-medium">Auto-download Data</label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="autoDownloadInterval" class="text-gray-700 font-medium">Interval (menit):</label>
                        <input type="number" id="autoDownloadInterval" value="5" min="1"
                               class="w-20 px-3 py-1 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm text-center">
                    </div>
                </div>
            </div>

            <!-- New sections for adding dropdown items -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Add Platform Option -->
                <div class="p-4 bg-gray-50 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Tambah Opsi Platform</h3>
                    <div class="flex flex-col sm:flex-row gap-2 mb-2">
                        <input type="text" id="platformOptionInput" placeholder="Nama Platform Baru"
                               class="flex-grow px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        <button id="addPlatformOptionButton"
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                            Tambah
                        </button>
                    </div>
                    <div class="mt-4">
                        <h4 class="text-md font-semibold text-gray-700 mb-2">Opsi Kustom Saat Ini:</h4>
                        <ul id="currentPlatformOptionsList" class="list-disc list-inside text-sm text-gray-600">
                            <!-- Custom platforms will be rendered here -->
                        </ul>
                    </div>
                </div>

                <!-- Add Store Option -->
                <div class="p-4 bg-gray-50 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Tambah Opsi Platform Digital</h3>
                    <div class="flex flex-col sm:flex-row gap-2 mb-2">
                        <input type="text" id="storeOptionInput" placeholder="Nama Toko Baru"
                               class="flex-grow px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        <button id="addStoreOptionButton"
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                            Tambah
                        </button>
                    </div>
                    <div class="mt-4">
                        <h4 class="text-md font-semibold text-gray-700 mb-2">Opsi Kustom Saat Ini:</h4>
                        <ul id="currentStoreOptionsList" class="list-disc list-inside text-sm text-gray-600">
                            <!-- Custom stores will be rendered here -->
                        </ul>
                    </div>
                </div>

                <!-- Add Lokasi Option -->
                <div class="p-4 bg-gray-50 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Tambah Opsi Mentahan</h3>
                    <div class="flex flex-col sm:flex-row gap-2 mb-2">
                        <input type="text" id="lokasiOptionInput" placeholder="Nama Lokasi Baru"
                               class="flex-grow px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        <button id="addLokasiOptionButton"
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                            Tambah
                        </button>
                    </div>
                    <div class="mt-4">
                        <h4 class="text-md font-semibold text-gray-700 mb-2">Opsi Kustom Saat Ini:</h4>
                        <ul id="currentLokasiOptionsList" class="list-disc list-inside text-sm text-gray-600">
                            <!-- Custom locations will be rendered here -->
                        </ul>
                    </div>
                </div>

                <!-- Add Status Option -->
                <div class="p-4 bg-gray-50 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Tambah Opsi Status</h3>
                    <div class="flex flex-col sm:flex-row gap-2 mb-2">
                        <input type="text" id="statusOptionInput" placeholder="Nama Status Baru"
                               class="flex-grow px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        <button id="addStatusOptionButton"
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                            Tambah
                        </button>
                    </div>
                    <div class="mt-4">
                        <h4 class="text-md font-semibold text-gray-700 mb-2">Opsi Kustom Saat Ini:</h4>
                        <ul id="currentStatusOptionsList" class="list-disc list-inside text-sm text-gray-600">
                            <!-- Custom statuses will be rendered here -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Custom Modal for Confirmation -->
    <div id="customModal" class="modal">
        <div class="modal-content">
            <p id="modalMessage" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="modalConfirmYes" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">Ya</button>
                <button id="modalConfirmNo" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">Tidak</button>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Messages -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <p id="messageModalText" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <button id="messageModalClose" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">OK</button>
        </div>
    </div>


    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GithubAuthProvider, signInWithPopup, linkWithPopup, signOut, signInWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, setDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let analytics;
        let userId = null;
        let authReady = false; // Flag to indicate if authentication is ready

        // Getting Canvas environment variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const canvasFirebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Fallback Firebase configuration (from your original provided script)
        const fallbackFirebaseConfig = {
            apiKey: "AIzaSyAzJTL179V9bT-DfefZq9gcG8Tz88VzLmQ",
            authDomain: "koleksi-game.firebaseapp.com",
            projectId: "koleksi-game",
            storageBucket: "koleksi-game.firebasestorage.app",
            messagingSenderId: "222959670551",
            appId: "1:222959670551:web:048b1e2c4ef16b7bd31352",
            measurementId: "G-BYYCM7R4M8"
        };

        // Determine which firebaseConfig to use
        const currentFirebaseConfig = canvasFirebaseConfig.projectId ? canvasFirebaseConfig : fallbackFirebaseConfig;
        console.log("Menggunakan konfigurasi Firebase:", currentFirebaseConfig);


        // Initialize Firebase
        function initializeFirebase() {
            try {
                app = initializeApp(currentFirebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                analytics = getAnalytics(app); // Initialize Analytics

                // Authenticate user
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // Menentukan nama tampilan yang lebih robust
                        let displayName = 'Pengguna GitHub'; // Default fallback
                        if (user.displayName) {
                            displayName = user.displayName;
                        } else if (user.email) {
                            displayName = user.email;
                        } else if (user.providerData && user.providerData.length > 0) {
                            // Cari nama tampilan dari data penyedia jika objek pengguna utama tidak memilikinya
                            const githubProvider = user.providerData.find(p => p.providerId === 'github.com');
                            if (githubProvider && githubProvider.displayName) {
                                displayName = githubProvider.displayName;
                            } else if (githubProvider && githubProvider.email) {
                                displayName = githubProvider.email;
                            }
                        }

                        if (!user.isAnonymous) {
                            // Jika login dengan metode persisten (seperti GitHub), tampilkan nama dan sembunyikan tombol
                            document.getElementById('userIdDisplay').textContent = `ID Pengguna: ${userId} (${displayName})`;
                            document.getElementById('githubSignInButton').classList.add('hidden');
                        } else {
                            // Jika anonim, tampilkan ID anonim dan tawarkan untuk menautkan
                            document.getElementById('userIdDisplay').textContent = `ID Pengguna: ${userId} (Anonim)`;
                            document.getElementById('githubSignInButton').classList.remove('hidden');
                            document.getElementById('githubSignInButton').textContent = 'Link dengan GitHub';
                        }
                        document.getElementById('signOutButton').classList.remove('hidden'); // Tampilkan tombol sign out
                        authReady = true;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        // Mulai memuat data setelah otentikasi siap
                        await loadAllDataFromFirestore();
                        showTab('game-list'); // Tampilkan tab awal setelah data dimuat
                    } else {
                        // Tidak login, coba anonim atau tampilkan opsi login
                        userId = null;
                        document.getElementById('userIdDisplay').textContent = "Anda belum login.";
                        document.getElementById('signOutButton').classList.add('hidden'); // Sembunyikan tombol sign out
                        document.getElementById('githubSignInButton').classList.remove('hidden');
                        document.getElementById('githubSignInButton').textContent = 'Login dengan GitHub'; // Reset teks
                        authReady = false; // Set authReady ke false jika pengguna adalah null
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            displayMessage("Gagal otentikasi dengan Firebase: " + error.message, "error");
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                displayMessage("Gagal menginisialisasi Firebase: " + error.message, "error");
            }
        }

        // Mendapatkan referensi elemen DOM
        const gameForm = document.getElementById('gameForm');
        const formTitle = document.getElementById('formTitle');
        const gameTitleInput = document.getElementById('gameTitle');
        const gamePlatformSelect = document.getElementById('gamePlatform');
        const manualPlatformInputContainer = document.getElementById('manualPlatformInputContainer');
        const manualGamePlatformInput = document.getElementById('manualGamePlatform');
        const gameStoreSelect = document.getElementById('gameStore');
        const manualStoreInputContainer = document.getElementById('manualStoreInputContainer');
        const manualGameStoreInput = document.getElementById('manualGameStore');
        const gameStatusSelect = document.getElementById('gameStatus');
        const lokasiMentahanSelect = document.getElementById('lokasiMentahan');
        const manualLokasiMentahanInputContainer = document.getElementById('manualLokasiMentahanInputContainer');
        const manualLokasiMentahanInput = document.getElementById('manualLokasiMentahan');
        const submitButton = document.getElementById('submitButton');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const gameListContainer = document.getElementById('gameList');
        const searchGameInput = document.getElementById('searchGame');
        const filterStatusSelect = document.getElementById('filterStatus');
        const filterPlatformSelect = document.getElementById('filterPlatform');
        const filterLokasiMentahanSelect = document.getElementById('filterLokasiMentahan');
        const sortGamesSelect = document.getElementById('sortGames');
        const noGamesMessage = document.getElementById('noGamesMessage');
        const gameStatusChartCanvas = document.getElementById('gameStatusChart');
        const platformChartCanvas = document.getElementById('platformChart');
        const lokasiMentahanChartCanvas = document.getElementById('lokasiMentahanChart');
        const gameStatusLegend = document.getElementById('gameStatusLegend');
        const platformLegend = document.getElementById('platformLegend');
        const lokasiMentahanLegend = document.getElementById('lokasiMentahanLegend');
        const paginationControls = document.getElementById('paginationControls');

        // Elements for file operations and auto-download
        const exportDataButton = document.getElementById('exportDataButton');
        const importDataButton = document.getElementById('importDataButton');
        const importFileInput = document.getElementById('importFileInput');
        const autoDownloadToggle = document.getElementById('autoDownloadToggle');
        const autoDownloadIntervalInput = document.getElementById('autoDownloadInterval');

        // Tab elements
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = {
            'game-list': document.getElementById('game-list'),
            'statistics': document.getElementById('statistics'),
            'data-management': document.getElementById('data-management')
        };

        // New DOM elements for adding dropdown items
        const platformOptionInput = document.getElementById('platformOptionInput');
        const addPlatformOptionButton = document.getElementById('addPlatformOptionButton');
        const currentPlatformOptionsList = document.getElementById('currentPlatformOptionsList');

        const storeOptionInput = document.getElementById('storeOptionInput');
        const addStoreOptionButton = document.getElementById('addStoreOptionButton');
        const currentStoreOptionsList = document.getElementById('currentStoreOptionsList');

        const lokasiOptionInput = document.getElementById('lokasiOptionInput');
        const addLokasiOptionButton = document.getElementById('addLokasiOptionButton');
        const currentLokasiOptionsList = document.getElementById('currentLokasiOptionsList');

        const statusOptionInput = document.getElementById('statusOptionInput');
        const addStatusOptionButton = document.getElementById('addStatusOptionButton');
        const currentStatusOptionsList = document.getElementById('currentStatusOptionsList');

        // Custom Modal elements
        const customModal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmYes = document.getElementById('modalConfirmYes');
        const modalConfirmNo = document.getElementById('modalConfirmNo');
        const messageModal = document.getElementById('messageModal');
        const messageModalText = document.getElementById('messageModalText');
        const messageModalClose = document.getElementById('messageModalClose');

        // GitHub Auth elements
        const githubSignInButton = document.getElementById('githubSignInButton');
        const signOutButton = document.getElementById('signOutButton');


        // Array untuk menyimpan koleksi game (akan diisi dari Firestore)
        let games = [];
        // Variabel untuk melacak game yang sedang diedit (Firestore doc ID)
        let editingGameId = null;

        // Variabel untuk pagination
        const gamesPerPage = 6;
        let currentPage = 1;

        // Instansi Chart.js
        let gameStatusPieChart = null;
        let platformPieChart = null;
        let lokasiMentahanPieChart = null;

        // Auto-download interval ID
        let autoDownloadIntervalId = null;
        let currentAutoDownloadInterval = 5; // Default 5 minutes

        // Default options for dropdowns (not including 'manual' option)
        const defaultPlatforms = ['PC', 'PS', 'PS2', 'PS3'];
        const defaultStores = ['Steam', 'Epic Games', 'GOG'];
        const defaultStatuses = ['Dimainkan', 'Belum Dimainkan', 'Selesai', 'Wishlist'];
        const defaultLokasiMentahanOptions = ['HDD Eksternal 4TB', 'HDD Eksternal 2TB'];

        // Custom options loaded/saved to Firestore
        let customPlatforms = [];
        let customStores = [];
        let customLocations = [];
        let customStatuses = [];

        // --- Fungsi Firestore ---

        // Helper untuk mendapatkan jalur koleksi
        function getGamesCollectionRef() {
            if (!userId) {
                console.error("ID Pengguna tidak tersedia untuk operasi Firestore.");
                return null;
            }
            return collection(db, `artifacts/${appId}/users/${userId}/games`);
        }

        function getCustomOptionsDocRef() {
            if (!userId) {
                console.error("ID Pengguna tidak tersedia untuk operasi Firestore.");
                return null;
            }
            return doc(db, `artifacts/${appId}/users/${userId}/app_data/custom_options`);
        }

        // Muat semua data dari Firestore (game dan opsi kustom)
        async function loadAllDataFromFirestore() {
            if (!authReady) {
                console.warn("Firestore belum siap. Otentikasi belum selesai.");
                return;
            }

            console.log("Memuat data game dari Firestore...");
            const gamesColRef = getGamesCollectionRef();
            if (gamesColRef) {
                onSnapshot(gamesColRef, (snapshot) => {
                    const loadedGames = [];
                    snapshot.forEach(doc => {
                        loadedGames.push({ id: doc.id, ...doc.data() });
                    });
                    games = loadedGames;
                    console.log("Game dimuat dari Firestore:", games);
                    currentPage = 1; // Reset halaman pada pembaruan data
                    renderAll();
                }, (error) => {
                    console.error("Error mendapatkan pembaruan game real-time:", error);
                    displayMessage("Gagal memuat game dari database: " + error.message, "error");
                });
            }

            console.log("Memuat opsi kustom dari Firestore...");
            const customOptionsDocRef = getCustomOptionsDocRef();
            if (customOptionsDocRef) {
                onSnapshot(customOptionsDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        customPlatforms = data.platforms || [];
                        customStores = data.stores || [];
                        customLocations = data.locations || [];
                        customStatuses = data.statuses || [];
                        console.log("Opsi kustom dimuat dari Firestore:", data);
                    } else {
                        console.log("Tidak ada opsi kustom ditemukan, menggunakan default.");
                        customPlatforms = [];
                        customStores = [];
                        customLocations = [];
                        customStatuses = [];
                    }
                    updateAllDropdowns(); // Perbarui UI setelah opsi kustom dimuat
                }, (error) => {
                    console.error("Error mendapatkan pembaruan opsi kustom real-time:", error);
                    displayMessage("Gagal memuat opsi kustom dari database: " + error.message, "error");
                });
            }

            // Muat status auto-download dan interval dari localStorage (tetap di localStorage)
            const autoDownloadEnabled = localStorage.getItem('autoDownloadEnabled') === 'true';
            const storedInterval = localStorage.getItem('autoDownloadInterval');
            if (storedInterval) {
                currentAutoDownloadInterval = parseInt(storedInterval);
            }
            autoDownloadIntervalInput.value = currentAutoDownloadInterval;
            autoDownloadToggle.checked = autoDownloadEnabled;
            toggleAutoDownload(autoDownloadEnabled, currentAutoDownloadInterval); // Kirim interval saat ini
        }

        // Simpan opsi dropdown kustom ke Firestore
        async function saveCustomDropdownOptionsToFirestore() {
            if (!authReady) {
                displayMessage("Aplikasi belum siap. Harap tunggu otentikasi selesai.", "error");
                return false;
            }
            const customOptionsDocRef = getCustomOptionsDocRef();
            if (!customOptionsDocRef) return false;

            try {
                await setDoc(customOptionsDocRef, {
                    platforms: customPlatforms,
                    stores: customStores,
                    locations: customLocations,
                    statuses: customStatuses
                }, { merge: true });
                console.log("Opsi kustom disimpan ke Firestore.");
                return true;
            } catch (e) {
                console.error("Error menyimpan opsi kustom ke Firestore:", e);
                displayMessage("Gagal menyimpan opsi kustom: " + e.message, "error");
                return false;
            }
        }

        // Fungsi untuk memigrasikan data dari satu UID ke UID lain
        async function migrateUserData(oldUid, newUid) {
            if (!db) {
                console.error("Firestore tidak diinisialisasi untuk migrasi data.");
                return;
            }

            console.log(`Memulai migrasi data dari ${oldUid} ke ${newUid}`);

            const oldGamesCollectionRef = collection(db, `artifacts/${appId}/users/${oldUid}/games`);
            const newGamesCollectionRef = collection(db, `artifacts/${appId}/users/${newUid}/games`);
            const oldCustomOptionsDocRef = doc(db, `artifacts/${appId}/users/${oldUid}/app_data/custom_options`);
            const newCustomOptionsDocRef = doc(db, `artifacts/${appId}/users/${newUid}/app_data/custom_options`);

            try {
                // 1. Migrasikan game
                const oldGamesSnapshot = await getDocs(oldGamesCollectionRef);
                const batch = getFirestore(app).batch(); // Gunakan batch untuk penulisan atomik

                oldGamesSnapshot.forEach((gameDoc) => {
                    const newDocRef = doc(newGamesCollectionRef, gameDoc.id); // Pertahankan ID asli jika memungkinkan
                    batch.set(newDocRef, gameDoc.data());
                });

                // 2. Migrasikan opsi kustom
                const oldCustomOptionsSnap = await getDoc(oldCustomOptionsDocRef);
                if (oldCustomOptionsSnap.exists()) {
                    batch.set(newCustomOptionsDocRef, oldCustomOptionsSnap.data(), { merge: true });
                }

                await batch.commit();
                console.log("Migrasi data game dan opsi kustom selesai.");

                // Opsional: Hapus data lama setelah migrasi berhasil (saat ini dinonaktifkan untuk keamanan)
                // oldGamesSnapshot.forEach((gameDoc) => {
                //     batch.delete(doc(oldGamesCollectionRef, gameDoc.id));
                // });
                // batch.delete(oldCustomOptionsDocRef);
                // await batch.commit();
                // console.log("Data lama berhasil dihapus.");

            } catch (e) {
                console.error("Error selama migrasi data:", e);
                throw e; // Lemparkan kembali untuk ditangkap oleh pemanggil untuk displayMessage
            }
        }

        // --- Fungsi generik untuk mengisi elemen select ---
        function populateSelect(selectElement, optionsArray, includeManual = true, addPlaceholder = false) {
            selectElement.innerHTML = '';
            if (addPlaceholder) {
                const placeholderOption = document.createElement('option');
                placeholderOption.value = "";
                placeholderOption.textContent = "Pilih Lokasi"; // Placeholder untuk dropdown Lokasi
                selectElement.appendChild(placeholderOption);
            }
            optionsArray.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
            if (includeManual) {
                const manualOpt = document.createElement('option');
                manualOpt.value = 'manual';
                manualOpt.textContent = 'Lainnya (input manual)';
                selectElement.appendChild(manualOpt);
            }
        }

        // --- Render daftar opsi kustom di tab Manajemen Data ---
        function renderCustomOptionsList(optionsArray, listElement) {
            listElement.innerHTML = '';
            if (optionsArray.length === 0) {
                listElement.innerHTML = '<li class="text-gray-500">Belum ada opsi kustom.</li>';
                return;
            }
            optionsArray.forEach(option => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center py-1';
                li.innerHTML = `
                    <span>${option}</span>
                    <button data-value="${option}" class="delete-custom-option-button text-red-500 hover:text-red-700 text-sm font-bold ml-2">Hapus</button>
                `;
                listElement.appendChild(li);
            });
        }

        // --- Perbarui semua dropdown yang relevan dengan opsi default dan kustom ---
        function updateAllDropdowns() {
            // Gabungkan opsi default dan kustom untuk setiap kategori
            const allPlatforms = [...new Set([...defaultPlatforms, ...customPlatforms])].sort();
            const allStores = [...new Set([...defaultStores, ...customStores])].sort();
            const allStatuses = [...new Set([...defaultStatuses, ...customStatuses])].sort();
            const allLokasiMentahan = [...new Set([...defaultLokasiMentahanOptions, ...customLocations])].sort();

            // Isi dropdown formulir game
            populateSelect(gamePlatformSelect, allPlatforms, true);
            populateSelect(gameStoreSelect, allStores, true);
            populateSelect(gameStatusSelect, allStatuses, false); // Dropdown Status tidak memiliki 'manual'
            populateSelect(lokasiMentahanSelect, allLokasiMentahan, true, true); // Lokasi memiliki placeholder dan manual

            // Isi dropdown filter (mereka tidak memerlukan opsi 'manual')
            populateSelect(filterPlatformSelect, ['all', ...allPlatforms], false); // Opsi 'all' ditangani
            populateSelect(filterStatusSelect, ['all', ...allStatuses], false);
            populateSelect(filterLokasiMentahanSelect, ['all', ...allLokasiMentahan], false);

            // Render daftar opsi kustom di tab manajemen data
            renderCustomOptionsList(customPlatforms, currentPlatformOptionsList);
            renderCustomOptionsList(customStores, currentStoreOptionsList);
            renderCustomOptionsList(customLocations, currentLokasiOptionsList);
            renderCustomOptionsList(customStatuses, currentStatusOptionsList);

            // Pulihkan nilai yang dipilih sebelumnya untuk filter jika tersedia
            filterPlatformSelect.value = filterPlatformSelect.dataset.currentValue || 'all';
            filterLokasiMentahanSelect.value = filterLokasiMentahanSelect.dataset.currentValue || 'all';
            filterStatusSelect.value = filterStatusSelect.dataset.currentValue || 'all'; // Juga untuk filter status
        }

        // --- Logika generik tambah opsi kustom ---
        async function handleAddCustomOption(inputElement, customArray, listElement) {
            if (!authReady) {
                displayMessage("Aplikasi belum siap. Harap tunggu otentikasi selesai.", "error");
                return;
            }

            const newItem = inputElement.value.trim();
            if (newItem && !customArray.includes(newItem)) {
                customArray.push(newItem);
                if (await saveCustomDropdownOptionsToFirestore()) {
                    displayMessage(`${newItem} berhasil ditambahkan!`, "success");
                    inputElement.value = '';
                    updateAllDropdowns(); // Isi ulang semua dropdown dan daftar
                }
            } else if (customArray.includes(newItem)) {
                displayMessage(`"${newItem}" sudah ada.`, "error");
            } else {
                displayMessage("Harap masukkan nama opsi.", "error");
            }
        }

        // --- Logika generik hapus opsi kustom ---
        function handleDeleteCustomOption(event, customArray) {
            if (!authReady) {
                displayMessage("Aplikasi belum siap. Harap tunggu otentikasi selesai.", "error");
                return;
            }

            const itemToDelete = event.target.dataset.value;
            displayConfirmation(`Apakah Anda yakin ingin menghapus "${itemToDelete}"?`, async () => {
                const index = customArray.indexOf(itemToDelete);
                if (index > -1) {
                    customArray.splice(index, 1);
                    if (await saveCustomDropdownOptionsToFirestore()) {
                        displayMessage(`"${itemToDelete}" berhasil dihapus.`, "success");
                        updateAllDropdowns(); // Isi ulang semua dropdown dan daftar
                    }
                }
            });
        }

        // Fungsi untuk merender (menampilkan) daftar game, menerapkan filter dan pengurutan
        function renderGames() {
            gameListContainer.innerHTML = ''; // Mengosongkan daftar yang ada
            const searchTerm = searchGameInput.value.toLowerCase();
            const filterStatus = filterStatusSelect.value;
            const filterPlatform = filterPlatformSelect.value;
            const filterLokasiMentahan = filterLokasiMentahanSelect.value;
            const sortOption = sortGamesSelect.value;

            // Filter game berdasarkan pencarian dan status
            let filteredGames = games.filter(game => {
                const matchesSearch = game.title.toLowerCase().includes(searchTerm) ||
                                      game.platform.toLowerCase().includes(searchTerm) ||
                                      game.store.toLowerCase().includes(searchTerm);
                const matchesStatus = filterStatus === 'all' || game.status === filterStatus;
                const matchesPlatform = filterPlatform === 'all' || game.platform === filterPlatform;
                const matchesLokasiMentahan = filterLokasiMentahan === 'all' || game.lokasiMentahan === filterLokasiMentahan;
                return matchesSearch && matchesStatus && matchesPlatform && matchesLokasiMentahan;
            });

            // Urutkan game
            filteredGames.sort((a, b) => {
                switch (sortOption) {
                    case 'title-asc':
                        return a.title.localeCompare(b.title);
                    case 'title-desc':
                        return b.title.localeCompare(a.title);
                    case 'platform-asc':
                        return a.platform.localeCompare(b.platform);
                    case 'status-asc':
                        return a.status.localeCompare(b.status);
                    default:
                        return 0;
                }
            });

            // Handle pagination
            const totalPages = Math.ceil(filteredGames.length / gamesPerPage);
            const startIndex = (currentPage - 1) * gamesPerPage;
            const endIndex = startIndex + gamesPerPage;
            const gamesToDisplay = filteredGames.slice(startIndex, endIndex);

            if (gamesToDisplay.length === 0) {
                noGamesMessage.classList.remove('hidden');
                paginationControls.innerHTML = '';
                return;
            } else {
                noGamesMessage.classList.add('hidden');
            }

            gamesToDisplay.forEach(game => {
                const gameCard = document.createElement('div');
                gameCard.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4 shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center';
                gameCard.innerHTML = `
                    <div class="flex-grow mb-3 sm:mb-0">
                        <h3 class="text-lg font-semibold text-gray-900">${game.title}</h3>
                        <p class="text-sm text-gray-600">Platform: ${game.platform}</p>
                        <p class="text-sm text-gray-600">Toko: ${game.store}</p>
                        <p class="text-sm text-gray-600">Status: <span class="font-medium ${
                            game.status === 'Dimainkan' ? 'text-blue-600' :
                            game.status === 'Selesai' ? 'text-green-600' :
                            game.status === 'Wishlist' ? 'text-purple-600' :
                            'text-gray-500'
                        }">${game.status}</span></p>
                        ${game.lokasiMentahan ? `<p class="text-sm text-gray-600">Mentahan: ${game.lokasiMentahan}</p>` : ''}
                    </div>
                    <div class="flex space-x-2 self-end sm:self-center">
                        <button data-id="${game.id}" class="edit-game-button bg-yellow-500 hover:bg-yellow-600 text-white py-1 px-3 rounded-md text-sm transition duration-300 ease-in-out transform hover:scale-105">
                            Edit
                        </button>
                        <button data-id="${game.id}" class="delete-game-button bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded-md text-sm transition duration-300 ease-in-out transform hover:scale-105">
                            Hapus
                        </button>
                    </div>
                `;
                gameListContainer.appendChild(gameCard);
            });

            renderPaginationControls(totalPages);
        }

        // Render kontrol paginasi
        function renderPaginationControls(totalPages) {
            paginationControls.innerHTML = '';
            if (totalPages <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Sebelumnya';
            prevButton.className = `px-4 py-2 rounded-md transition duration-300 ${currentPage === 1 ? 'bg-gray-300 text-gray-600 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600 text-white'}`;
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderGames();
                }
            });
            paginationControls.appendChild(prevButton);

            const pageInfo = document.createElement('span');
            pageInfo.textContent = `Halaman ${currentPage} dari ${totalPages}`;
            pageInfo.className = 'mx-4 text-gray-700 font-medium';
            paginationControls.appendChild(pageInfo);

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Berikutnya';
            nextButton.className = `px-4 py-2 rounded-md transition duration-300 ${currentPage === totalPages ? 'bg-gray-300 text-gray-600 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600 text-white'}`;
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderGames();
                }
            });
            paginationControls.appendChild(nextButton);
        }


        // Fungsi untuk merender chart statistik
        function renderStatistics() {
            // Hancurkan chart yang ada sebelum membuat yang baru untuk mencegah duplikasi
            if (gameStatusPieChart) gameStatusPieChart.destroy();
            if (platformPieChart) platformPieChart.destroy();
            if (lokasiMentahanPieChart) lokasiMentahanPieChart.destroy();

            // Data untuk Status Game
            const statusCounts = {};
            games.forEach(game => {
                statusCounts[game.status] = (statusCounts[game.status] || 0) + 1;
            });
            const statusLabels = Object.keys(statusCounts);
            const statusData = Object.values(statusCounts);
            const statusColors = statusLabels.map(label => {
                switch (label) {
                    case 'Dimainkan': return '#3B82F6'; // blue-500
                    case 'Belum Dimainkan': return '#F59E0B'; // amber-500
                    case 'Selesai': return '#10B981'; // emerald-500
                    case 'Wishlist': return '#8B5CF6'; // violet-500
                    default: return '#6B7280'; // gray-500
                }
            });
            gameStatusPieChart = new Chart(gameStatusChartCanvas, {
                type: 'pie',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        data: statusData,
                        backgroundColor: statusColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // Hide default legend
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed + ' game';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            generateLegend(gameStatusLegend, statusLabels, statusColors, statusData, ' game');


            // Data untuk Platform
            const platformCounts = {};
            games.forEach(game => {
                platformCounts[game.platform] = (platformCounts[game.platform] || 0) + 1;
            });
            const platformLabels = Object.keys(platformCounts);
            const platformData = Object.values(platformCounts);
            const platformColors = generateRandomColors(platformLabels.length);
            platformPieChart = new Chart(platformChartCanvas, {
                type: 'pie',
                data: {
                    labels: platformLabels,
                    datasets: [{
                        data: platformData,
                        backgroundColor: platformColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed + ' game';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            generateLegend(platformLegend, platformLabels, platformColors, platformData, ' game');


            // Data untuk Lokasi Mentahan
            const lokasiMentahanCounts = {};
            games.forEach(game => {
                if (game.lokasiMentahan) {
                    lokasiMentahanCounts[game.lokasiMentahan] = (lokasiMentahanCounts[game.lokasiMentahan] || 0) + 1;
                }
            });
            const lokasiMentahanLabels = Object.keys(lokasiMentahanCounts);
            const lokasiMentahanData = Object.values(lokasiMentahanCounts);
            const lokasiMentahanColors = generateRandomColors(lokasiMentahanLabels.length);
            lokasiMentahanPieChart = new Chart(lokasiMentahanChartCanvas, {
                type: 'pie',
                data: {
                    labels: lokasiMentahanLabels,
                    datasets: [{
                        data: lokasiMentahanData,
                        backgroundColor: lokasiMentahanColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed + ' game';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            generateLegend(lokasiMentahanLegend, lokasiMentahanLabels, lokasiMentahanColors, lokasiMentahanData, ' game');

            // Sembunyikan atau tampilkan bagian statistik jika tidak ada data
            document.getElementById('gameStatisticsSection').classList.toggle('hidden', statusData.length === 0);
            document.getElementById('platformStatisticsSection').classList.toggle('hidden', platformData.length === 0);
            document.getElementById('lokasiMentahanStatisticsSection').classList.toggle('hidden', lokasiMentahanData.length === 0);
        }

        // Fungsi pembantu untuk membuat legenda kustom
        function generateLegend(legendElement, labels, colors, data, suffix = '') {
            legendElement.innerHTML = '';
            labels.forEach((label, index) => {
                const legendItem = document.createElement('div');
                legendItem.className = 'flex items-center space-x-2 text-gray-700';
                legendItem.innerHTML = `
                    <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${colors[index]}"></span>
                    <span>${label}: ${data[index]}${suffix}</span>
                `;
                legendElement.appendChild(legendItem);
            });
        }

        // Fungsi pembantu untuk menghasilkan warna acak
        function generateRandomColors(numColors) {
            const colors = [];
            for (let i = 0; i < numColors; i++) {
                const hue = (i * 137.508) % 360; // Use golden angle approximation for even distribution
                colors.push(`hsl(${hue}, 70%, 50%)`);
            }
            return colors;
        }

        // Fungsi untuk merender semua yang perlu di-render ulang saat data berubah
        function renderAll() {
            renderGames();
            renderStatistics();
            updateAllDropdowns();
        }

        // --- Event Listeners ---

        // GitHub Sign-in/Link Button
        githubSignInButton.addEventListener('click', async () => {
            if (!authReady) {
                displayMessage("Aplikasi belum siap. Harap tunggu otentikasi selesai.", "error");
                return;
            }
            const provider = new GithubAuthProvider();
            try {
                // Tentukan apakah kita menautkan akun anonim yang sudah ada atau masuk dari awal
                const isAnonymousSession = auth.currentUser && auth.currentUser.isAnonymous;
                let result;

                if (isAnonymousSession) {
                    // Jika saat ini login secara anonim, coba tautkan akun GitHub
                    result = await linkWithPopup(auth.currentUser, provider);
                    console.log("Akun GitHub berhasil ditautkan:", result.user);
                    displayMessage("Akun GitHub berhasil ditautkan!", "success");
                } else {
                    // Jika tidak login atau login dengan penyedia berbeda, masuk dengan GitHub
                    result = await signInWithPopup(auth, provider);
                    console.log("Berhasil masuk dengan GitHub:", result.user);
                    displayMessage("Berhasil masuk dengan GitHub!", "success");
                }
            } catch (error) {
                console.error("Error dengan otentikasi GitHub:", error);
                if (error.code === 'auth/account-exists-with-different-credential') {
                    // Ini adalah error yang dialami pengguna.
                    // Akun GitHub sudah terhubung ke akun Firebase lain.
                    const email = error.customData.email;
                    const credential = GithubAuthProvider.credentialFromError(error);
                    const oldAnonymousUid = auth.currentUser?.isAnonymous ? auth.currentUser.uid : null; // Tangkap UID anonim

                    displayConfirmation(
                        `Akun GitHub ini sudah digunakan dengan email lain (${email}). Apakah Anda ingin masuk dengan akun yang sudah ada ini? Data Anda akan digabungkan jika Anda sebelumnya login anonim.`,
                        async () => {
                            try {
                                // Masuk dengan kredensial akun yang sudah ada (dalam kasus ini, kredensial GitHub)
                                // Ini akan mengarahkan pengguna untuk masuk ke akun Firebase yang sudah ada yang menggunakan login GitHub ini.
                                const signInResult = await signInWithCredential(auth, credential);
                                const newUid = signInResult.user.uid;
                                console.log("Berhasil masuk dengan kredensial GitHub yang bertentangan. UID Baru:", newUid);
                                displayMessage("Berhasil masuk dengan akun yang sudah ada!", "success");

                                // Jika sesi sebelumnya anonim dan UID berubah, migrasikan data
                                if (oldAnonymousUid && oldAnonymousUid !== newUid) {
                                    console.log(`Memigrasikan data dari anonim (${oldAnonymousUid}) ke akun GitHub (${newUid})...`);
                                    await migrateUserData(oldAnonymousUid, newUid);
                                    displayMessage("Data berhasil dimigrasikan!", "success");
                                }

                            } catch (mergeError) {
                                console.error("Error saat masuk dengan kredensial yang sudah ada atau migrasi data:", mergeError);
                                displayMessage("Gagal masuk dengan akun yang sudah ada atau memigrasikan data: " + mergeError.message, "error");
                            }
                        }
                    );
                } else if (error.code === 'auth/popup-closed-by-user') {
                    displayMessage("Proses login GitHub dibatalkan.", "info");
                } else {
                    displayMessage("Terjadi kesalahan saat masuk dengan GitHub: " + error.message, "error");
                }
            }
        });


        // Sign Out Button
        signOutButton.addEventListener('click', async () => {
            if (!authReady) {
                displayMessage("Aplikasi belum siap. Harap tunggu otentikasi selesai.", "error");
                return;
            }
            displayConfirmation('Apakah Anda yakin ingin keluar?', async () => {
                try {
                    await signOut(auth);
                    games = []; // Clear games data on sign out
                    currentPage = 1;
                    renderAll(); // Rerender to show empty state
                    displayMessage("Berhasil keluar.", "success");
                } catch (error) {
                    console.error("Error signing out:", error);
                    displayMessage("Gagal keluar: " + error.message, "error");
                }
            });
        });

        // Formulir Tambah/Edit Game
        gameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!authReady) {
                displayMessage("Aplikasi belum siap. Harap tunggu otentikasi selesai.", "error");
                return;
            }

            let platformValue = gamePlatformSelect.value;
            if (platformValue === 'manual') {
                platformValue = manualGamePlatformInput.value.trim();
                if (platformValue && !customPlatforms.includes(platformValue)) {
                    customPlatforms.push(platformValue);
                    await saveCustomDropdownOptionsToFirestore(); // Save new custom platform
                }
            }

            let storeValue = gameStoreSelect.value;
            if (storeValue === 'manual') {
                storeValue = manualGameStoreInput.value.trim();
                if (storeValue && !customStores.includes(storeValue)) {
                    customStores.push(storeValue);
                    await saveCustomDropdownOptionsToFirestore(); // Save new custom store
                }
            }

            let lokasiMentahanValue = lokasiMentahanSelect.value;
            if (lokasiMentahanValue === 'manual') {
                lokasiMentahanValue = manualLokasiMentahanInput.value.trim();
                if (lokasiMentahanValue && !customLocations.includes(lokasiMentahanValue)) {
                    customLocations.push(lokasiMentahanValue);
                    await saveCustomDropdownOptionsToFirestore(); // Save new custom location
                }
            }

            const gameData = {
                title: gameTitleInput.value.trim(),
                platform: platformValue,
                store: storeValue,
                status: gameStatusSelect.value,
                lokasiMentahan: lokasiMentahanValue || null // Ensure it's null if empty
            };

            const gamesColRef = getGamesCollectionRef();
            if (!gamesColRef) return;

            try {
                if (editingGameId) {
                    // Mode edit
                    await updateDoc(doc(gamesColRef, editingGameId), gameData);
                    displayMessage("Game berhasil diperbarui!", "success");
                } else {
                    // Mode tambah
                    await addDoc(gamesColRef, gameData);
                    displayMessage("Game berhasil ditambahkan!", "success");
                }
                gameForm.reset(); // Reset formulir
                editingGameId = null; // Reset mode edit
                submitButton.textContent = 'Tambah Game';
                formTitle.textContent = ''; // Clear title
                cancelEditButton.classList.add('hidden'); // Sembunyikan tombol batal edit
                manualPlatformInputContainer.classList.add('hidden');
                manualGamePlatformInput.value = '';
                manualStoreInputContainer.classList.add('hidden');
                manualGameStoreInput.value = '';
                manualLokasiMentahanInputContainer.classList.add('hidden');
                manualLokasiMentahanInput.value = '';
                updateAllDropdowns(); // Re-populate dropdowns to show new custom options
            } catch (e) {
                console.error("Error menambah/memperbarui dokumen: ", e);
                displayMessage("Gagal menambah/memperbarui game: " + e.message, "error");
            }
        });

        // Event listener untuk tombol Edit/Hapus pada daftar game (delegasi event)
        gameListContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('edit-game-button')) {
                if (!authReady) {
                    displayMessage("Aplikasi belum siap. Harap tunggu otentikasi selesai.", "error");
                    return;
                }
                const gameId = e.target.dataset.id;
                const gameToEdit = games.find(game => game.id === gameId);
                if (gameToEdit) {
                    gameTitleInput.value = gameToEdit.title;
                    gamePlatformSelect.value = gameToEdit.platform;
                    if (![...defaultPlatforms, ...customPlatforms].includes(gameToEdit.platform)) {
                        gamePlatformSelect.value = 'manual';
                        manualPlatformInputContainer.classList.remove('hidden');
                        manualGamePlatformInput.value = gameToEdit.platform;
                    } else {
                        manualPlatformInputContainer.classList.add('hidden');
                    }

                    gameStoreSelect.value = gameToEdit.store;
                    if (![...defaultStores, ...customStores].includes(gameToEdit.store)) {
                        gameStoreSelect.value = 'manual';
                        manualStoreInputContainer.classList.remove('hidden');
                        manualGameStoreInput.value = gameToEdit.store;
                    } else {
                        manualStoreInputContainer.classList.add('hidden');
                    }

                    gameStatusSelect.value = gameToEdit.status;
                    lokasiMentahanSelect.value = gameToEdit.lokasiMentahan || '';
                     if (gameToEdit.lokasiMentahan && ![...defaultLokasiMentahanOptions, ...customLocations].includes(gameToEdit.lokasiMentahan)) {
                        lokasiMentahanSelect.value = 'manual';
                        manualLokasiMentahanInputContainer.classList.remove('hidden');
                        manualLokasiMentahanInput.value = gameToEdit.lokasiMentahan;
                    } else {
                        manualLokasiMentahanInputContainer.classList.add('hidden');
                    }


                    submitButton.textContent = 'Perbarui Game';
                    formTitle.textContent = 'Edit Game';
                    editingGameId = gameId;
                    cancelEditButton.classList.remove('hidden'); // Tampilkan tombol batal edit
                    window.scrollTo({ top: 0, behavior: 'smooth' }); // Gulir ke atas formulir
                }
            } else if (e.target.classList.contains('delete-game-button')) {
                if (!authReady) {
                    displayMessage("Aplikasi belum siap. Harap tunggu otentikasi selesai.", "error");
                    return;
                }
                const gameId = e.target.dataset.id;
                displayConfirmation('Apakah Anda yakin ingin menghapus game ini?', async () => {
                    const gamesColRef = getGamesCollectionRef();
                    if (!gamesColRef) return;
                    try {
                        await deleteDoc(doc(gamesColRef, gameId));
                        displayMessage("Game berhasil dihapus!", "success");
                    } catch (e) {
                        console.error("Error menghapus dokumen: ", e);
                        displayMessage("Gagal menghapus game: " + e.message, "error");
                    }
                });
            }
        });

        // Event listener untuk tombol batal edit
        cancelEditButton.addEventListener('click', () => {
            gameForm.reset();
            editingGameId = null;
            submitButton.textContent = 'Tambah Game';
            formTitle.textContent = '';
            cancelEditButton.classList.add('hidden');
            manualPlatformInputContainer.classList.add('hidden');
            manualGamePlatformInput.value = '';
            manualStoreInputContainer.classList.add('hidden');
            manualGameStoreInput.value = '';
            manualLokasiMentahanInputContainer.classList.add('hidden');
            manualLokasiMentahanInput.value = '';
        });

        // Event listener untuk pilihan 'manual' pada dropdown platform
        gamePlatformSelect.addEventListener('change', (e) => {
            if (e.target.value === 'manual') {
                manualPlatformInputContainer.classList.remove('hidden');
            } else {
                manualPlatformInputContainer.classList.add('hidden');
                manualGamePlatformInput.value = '';
            }
        });

        // Event listener untuk pilihan 'manual' pada dropdown store
        gameStoreSelect.addEventListener('change', (e) => {
            if (e.target.value === 'manual') {
                manualStoreInputContainer.classList.remove('hidden');
            } else {
                manualStoreInputContainer.classList.add('hidden');
                manualGameStoreInput.value = '';
            }
        });

        // Event listener untuk pilihan 'manual' pada dropdown lokasi mentahan
        lokasiMentahanSelect.addEventListener('change', (e) => {
            if (e.target.value === 'manual') {
                manualLokasiMentahanInputContainer.classList.remove('hidden');
            } else {
                manualLokasiMentahanInputContainer.classList.add('hidden');
                manualLokasiMentahanInput.value = '';
            }
        });

        // Event listener untuk pencarian
        searchGameInput.addEventListener('input', renderGames);

        // Event listener untuk filter status
        filterStatusSelect.addEventListener('change', () => {
            filterStatusSelect.dataset.currentValue = filterStatusSelect.value; // Store current value
            renderGames();
        });

        // Event listener untuk filter platform
        filterPlatformSelect.addEventListener('change', () => {
            filterPlatformSelect.dataset.currentValue = filterPlatformSelect.value; // Store current value
            renderGames();
        });

        // Event listener untuk filter lokasi mentahan
        filterLokasiMentahanSelect.addEventListener('change', () => {
            filterLokasiMentahanSelect.dataset.currentValue = filterLokasiMentahanSelect.value; // Store current value
            renderGames();
        });

        // Event listener untuk pengurutan
        sortGamesSelect.addEventListener('change', renderGames);

        // Event listener untuk tombol ekspor data
        exportDataButton.addEventListener('click', () => {
            if (!authReady) {
                displayMessage("Aplikasi belum siap. Harap tunggu otentikasi selesai.", "error");
                return;
            }
            const dataToExport = {
                games: games,
                customOptions: {
                    platforms: customPlatforms,
                    stores: customStores,
                    locations: customLocations,
                    statuses: customStatuses
                }
            };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `koleksi_game_data_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            displayMessage("Data berhasil diekspor!", "success");
        });

        // Event listener untuk tombol impor data
        importDataButton.addEventListener('click', () => {
            if (!authReady) {
                displayMessage("Aplikasi belum siap. Harap tunggu otentikasi selesai.", "error");
                return;
            }
            importFileInput.click(); // Trigger the hidden file input
        });

        importFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.games && Array.isArray(importedData.games)) {
                        // For simplicity, we'll overwrite existing data.
                        // In a more complex app, you might ask to merge or replace.
                        const gamesColRef = getGamesCollectionRef();
                        if (!gamesColRef) return;

                        // Clear existing games first (optional, for clean overwrite)
                        // This part is tricky with real-time listeners.
                        // A safer approach for importing is to add/update documents one by one.

                        for (const game of importedData.games) {
                            // Firestore auto-generates IDs if you use addDoc.
                            // If you want to retain IDs from export, use setDoc with a specific ID.
                            // For simplicity, assuming new IDs for imported games, or merge by title.
                            // Here we will add as new documents.
                            const { id, ...gameWithoutId } = game; // Remove ID to let Firestore generate new one or use existing
                            // If `id` exists in imported data, try to set it, otherwise add new
                            if (id) {
                                await setDoc(doc(gamesColRef, id), gameWithoutId, { merge: true });
                            } else {
                                await addDoc(gamesColRef, gameWithoutId);
                            }
                        }
                        displayMessage("Game berhasil diimpor!", "success");
                    }

                    if (importedData.customOptions) {
                        if (importedData.customOptions.platforms) {
                            customPlatforms = [...new Set([...customPlatforms, ...importedData.customOptions.platforms])].sort();
                        }
                        if (importedData.customOptions.stores) {
                            customStores = [...new Set([...customStores, ...importedData.customOptions.stores])].sort();
                        }
                        if (importedData.customOptions.locations) {
                            customLocations = [...new Set([...customLocations, ...importedData.customOptions.locations])].sort();
                        }
                        if (importedData.customOptions.statuses) {
                            customStatuses = [...new Set([...customStatuses, ...importedData.customOptions.statuses])].sort();
                        }
                        await saveCustomDropdownOptionsToFirestore(); // Save merged custom options
                        displayMessage("Opsi kustom berhasil diimpor dan digabungkan!", "success");
                    }
                } catch (error) {
                    console.error("Error importing data:", error);
                    displayMessage("Gagal mengimpor data: File JSON tidak valid atau terjadi kesalahan.", "error");
                }
            };
            reader.readAsText(file);
        });

        // Auto-download toggle
        autoDownloadToggle.addEventListener('change', (e) => {
            const isEnabled = e.target.checked;
            localStorage.setItem('autoDownloadEnabled', isEnabled);
            toggleAutoDownload(isEnabled, currentAutoDownloadInterval);
            displayMessage(`Auto-download ${isEnabled ? 'diaktifkan' : 'dinonaktifkan'}.`, "info");
        });

        // Auto-download interval change
        autoDownloadIntervalInput.addEventListener('change', (e) => {
            const newInterval = parseInt(e.target.value);
            if (newInterval > 0) {
                currentAutoDownloadInterval = newInterval;
                localStorage.setItem('autoDownloadInterval', newInterval);
                if (autoDownloadToggle.checked) {
                    toggleAutoDownload(false); // Stop current interval
                    toggleAutoDownload(true, currentAutoDownloadInterval); // Start with new interval
                    displayMessage(`Interval auto-download diatur ke ${newInterval} menit.`, "info");
                }
            } else {
                e.target.value = currentAutoDownloadInterval; // Revert to last valid
                displayMessage("Interval harus lebih besar dari 0.", "error");
            }
        });

        function toggleAutoDownload(enable, intervalMinutes) {
            if (autoDownloadIntervalId) {
                clearInterval(autoDownloadIntervalId);
                autoDownloadIntervalId = null;
            }
            if (enable) {
                autoDownloadIntervalId = setInterval(() => {
                    exportDataButton.click(); // Programmatically click export button
                    console.log(`Auto-download triggered at ${new Date().toLocaleTimeString()}`);
                }, intervalMinutes * 60 * 1000); // Convert minutes to milliseconds
                console.log(`Auto-download dijadwalkan setiap ${intervalMinutes} menit.`);
            }
        }

        // --- Event Listeners untuk Menambahkan Opsi Dropdown Kustom ---
        addPlatformOptionButton.addEventListener('click', () => handleAddCustomOption(platformOptionInput, customPlatforms, currentPlatformOptionsList));
        addStoreOptionButton.addEventListener('click', () => handleAddCustomOption(storeOptionInput, customStores, currentStoreOptionsList));
        addLokasiOptionButton.addEventListener('click', () => handleAddCustomOption(lokasiOptionInput, customLocations, currentLokasiOptionsList));
        addStatusOptionButton.addEventListener('click', () => handleAddCustomOption(statusOptionInput, customStatuses, currentStatusOptionsList));

        // Event delegation for deleting custom options
        currentPlatformOptionsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-custom-option-button')) {
                handleDeleteCustomOption(e, customPlatforms);
            }
        });
        currentStoreOptionsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-custom-option-button')) {
                handleDeleteCustomOption(e, customStores);
            }
        });
        currentLokasiOptionsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-custom-option-button')) {
                handleDeleteCustomOption(e, customLocations);
            }
        });
        currentStatusOptionsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-custom-option-button')) {
                handleDeleteCustomOption(e, customStatuses);
            }
        });

        // --- Tab Navigation ---
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                showTab(tabId);
            });
        });

        function showTab(tabId) {
            tabButtons.forEach(button => {
                if (button.dataset.tab === tabId) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            for (const id in tabContents) {
                if (id === tabId) {
                    tabContents[id].classList.remove('hidden');
                } else {
                    tabContents[id].classList.add('hidden');
                }
            }

            // Render statistics only when the statistics tab is shown
            if (tabId === 'statistics') {
                renderStatistics();
            }
        }


        // --- Custom Modal Functions ---
        let resolveConfirmation;

        function displayConfirmation(message, onConfirm) {
            modalMessage.textContent = message;
            customModal.style.display = 'flex'; // Use flex to center
            return new Promise((resolve) => {
                resolveConfirmation = resolve;
                modalConfirmYes.onclick = () => {
                    customModal.style.display = 'none';
                    onConfirm();
                    resolve(true);
                };
                modalConfirmNo.onclick = () => {
                    customModal.style.display = 'none';
                    resolve(false);
                };
            });
        }

        function displayMessage(message, type = "info") {
            messageModalText.textContent = message;
            // You can add different styling based on type (success, error, info) if needed
            messageModal.style.display = 'flex'; // Use flex to center
            messageModalClose.onclick = () => {
                messageModal.style.display = 'none';
            };
        }

        // Initialize Firebase and load data on window load
        window.onload = initializeFirebase;
    </script>
</body>
</html>
