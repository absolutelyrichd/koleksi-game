<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koleksi Game</title>
    <!-- Memuat Tailwind CSS dari CDN untuk styling yang cepat dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Chart.js untuk diagram lingkaran -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Mengatur font default menjadi Inter dan mengecilkan ukurannya */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Warna latar belakang abu-abu muda */
            font-size: 0.9em; /* Mengurangi ukuran font keseluruhan satu tingkat */
        }
        /* Styling untuk scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* Memastikan canvas responsif */
        canvas {
            max-width: 100%;
            height: auto;
        }
        /* Styling untuk tab aktif */
        .tab-button.active {
            background-color: #4c51bf; /* indigo-700 */
            color: white;
            border-bottom-color: #4c51bf;
            border-bottom-width: 2px;
        }
        /* Basic modal styling */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8 lg:p-10 bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="container mx-auto bg-white rounded-lg shadow-xl p-6 md:p-8 lg:p-10 max-w-4xl w-full">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-6 text-center">Koleksi Game</h1>

        <!-- Display User ID -->
        <p id="userIdDisplay" class="text-sm text-gray-500 text-center mb-4">Memuat ID Pengguna...</p>

        <!-- Form untuk Menambahkan/Mengedit Game (Dipindahkan di luar tab) -->
        <div class="mb-8 p-6 bg-blue-50 rounded-lg shadow-md">
            <h2 id="formTitle" class="text-xl font-semibold text-blue-800 mb-4"> </h2>
            <form id="gameForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="gameTitle" class="block text-sm font-medium text-gray-700 mb-1">Judul Game</label>
                    <input type="text" id="gameTitle" placeholder="Misal: Cyberpunk 2077" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                </div>
                <div>
                    <label for="gamePlatform" class="block text-sm font-medium text-gray-700 mb-1">Platform</label>
                    <select id="gamePlatform"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div id="manualPlatformInputContainer" class="hidden">
                    <label for="manualGamePlatform" class="block text-sm font-medium text-gray-700 mb-1">Lainnya</label>
                    <input type="text" id="manualGamePlatform" placeholder="Masukkan nama platform"
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                </div>
                <div>
                    <label for="gameStore" class="block text-sm font-medium text-gray-700 mb-1">Platform Digital</label>
                    <select id="gameStore"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div id="manualStoreInputContainer" class="hidden">
                    <label for="manualGameStore" class="block text-sm font-medium text-gray-700 mb-1">Lainnya</label>
                    <input type="text" id="manualGameStore" placeholder="Masukkan nama toko"
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                </div>
                <div>
                    <label for="gameStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="gameStatus"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label for="lokasiMentahan" class="block text-sm font-medium text-gray-700 mb-1">Mentahan (Opsional)</label>
                    <select id="lokasiMentahan"
                            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div id="manualLokasiMentahanInputContainer" class="hidden md:col-span-2">
                    <label for="manualLokasiMentahan" class="block text-sm font-medium text-gray-700 mb-1">Lainnya</label>
                    <input type="text" id="manualLokasiMentahan" placeholder="Masukkan nama lokasi"
                           class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                </div>
                <div class="md:col-span-2 flex justify-end space-x-3">
                    <button type="button" id="cancelEditButton"
                            class="hidden bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                        Batal Edit
                    </button>
                    <button type="submit" id="submitButton"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                        Tambah Game
                    </button>
                </div>
            </form>
        </div>

        <!-- Navigasi Tab (Dipindahkan di bawah form) -->
        <div class="flex border-b border-gray-200 mb-6">
            <button class="tab-button active px-4 py-2 text-lg font-medium text-gray-700 hover:text-indigo-700 transition duration-300 ease-in-out" data-tab="game-list">Koleksi Game</button>
            <button class="tab-button px-4 py-2 text-lg font-medium text-gray-700 hover:text-indigo-700 transition duration-300 ease-in-out" data-tab="statistics">Statistik</button>
            <button class="tab-button px-4 py-2 text-lg font-medium text-gray-700 hover:text-indigo-700 transition duration-300 ease-in-out" data-tab="data-management">Data</button>
        </div>

        <!-- Konten Tab -->
        <div id="game-list" class="tab-content">
            <!-- Filter, Pencarian, dan Pengurutan -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg shadow-md">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Filter, Pencarian & Pengurutan</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label for="searchGame" class="block text-sm font-medium text-gray-700 mb-1">Cari Game</label>
                        <input type="text" id="searchGame" placeholder="Cari berdasarkan judul, platform, atau toko..."
                               class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 shadow-sm">
                    </div>
                    <div>
                        <label for="filterStatus" class="block text-sm font-medium text-gray-700 mb-1">Filter Status</label>
                        <select id="filterStatus"
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 shadow-sm">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="filterPlatform" class="block text-sm font-medium text-gray-700 mb-1">Filter Platform</label>
                        <select id="filterPlatform"
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 shadow-sm">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="filterLokasiMentahan" class="block text-sm font-medium text-gray-700 mb-1">Filter Mentahan</label>
                        <select id="filterLokasiMentahan"
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 shadow-sm">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="sortGames" class="block text-sm font-medium text-gray-700 mb-1">Urutkan Berdasarkan</label>
                        <select id="sortGames"
                                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500 shadow-sm">
                            <option value="title-asc">Judul (A-Z)</option>
                            <option value="title-desc">Judul (Z-A)</option>
                            <option value="platform-asc">Platform (A-Z)</option>
                            <option value="status-asc">Status (A-Z)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Daftar Koleksi Game -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Daftar Game</h2>
                <div id="gameList" class="space-y-4">
                    <!-- Daftar game akan dirender di sini oleh JavaScript -->
                    <p id="noGamesMessage" class="text-gray-500 text-center hidden">Belum ada game dalam koleksi Anda. Tambahkan game baru di atas!</p>
                </div>
                <div id="paginationControls" class="flex justify-center items-center mt-6 space-x-2">
                    <!-- Kontrol paginasi akan dirender di sini oleh JavaScript -->
                </div>
            </div>
        </div>

        <div id="statistics" class="tab-content hidden">
            <!-- Statistik Koleksi -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg shadow-md">
                <h2 class="text-lg font-semibold text-gray-700 mb-3">Statistik Koleksi</h2>
                <div id="statistics-charts" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div id="gameStatisticsSection" class="p-4 bg-cyan-100 rounded-lg shadow-md flex flex-col items-center">
                        <h3 class="text-base font-semibold text-cyan-800 mb-2">Statistik Game (Berdasarkan Status)</h3>
                        <div class="relative w-full h-64">
                            <canvas id="gameStatusChart"></canvas>
                        </div>
                        <div id="gameStatusLegend" class="mt-4 text-xs"></div>
                    </div>
                    <div id="platformStatisticsSection" class="p-4 bg-indigo-100 rounded-lg shadow-md flex flex-col items-center">
                        <h3 class="text-base font-semibold text-indigo-800 mb-2">Statistik Platform</h3>
                        <div class="relative w-full h-64">
                            <canvas id="platformChart"></canvas>
                        </div>
                        <div id="platformLegend" class="mt-4 text-xs"></div>
                    </div>
                    <div id="lokasiMentahanStatisticsSection" class="p-4 bg-teal-100 rounded-lg shadow-md flex flex-col items-center">
                        <h3 class="text-base font-semibold text-teal-800 mb-2">Statistik Lokasi</h3>
                        <div class="relative w-full h-64">
                            <canvas id="lokasiMentahanChart"></canvas>
                        </div>
                        <div id="lokasiMentahanLegend" class="mt-4 text-xs"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="data-management" class="tab-content hidden">
            <!-- Tombol untuk Simpan/Muat Data -->
            <div class="mb-8 p-4 bg-purple-50 rounded-lg shadow-md flex flex-wrap justify-center gap-4">
                <h2 class="text-xl font-semibold text-purple-800 w-full text-center mb-3"></h2>
                <button id="exportDataButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                    Ekspor Data (JSON)
                </button>
                <input type="file" id="importFileInput" accept=".json" class="hidden">
                <button id="importDataButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:scale-105">
                    Impor Data (JSON)
                </button>
                <div class="flex items-center justify-center gap-4 w-full mt-4">
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="autoDownloadToggle" class="form-checkbox h-5 w-5 text-blue-600 rounded-md">
                        <label for="autoDownloadToggle" class="text-gray-700 font-medium">Auto-download Data</label>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="autoDownloadInterval" class="text-gray-700 font-medium">Interval (menit):</label>
                        <input type="number" id="autoDownloadInterval" value="5" min="1"
                               class="w-20 px-3 py-1 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm text-center">
                    </div>
                </div>
            </div>

            <!-- New sections for adding dropdown items -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Add Platform Option -->
                <div class="p-4 bg-gray-50 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Tambah Opsi Platform</h3>
                    <div class="flex flex-col sm:flex-row gap-2 mb-2">
                        <input type="text" id="platformOptionInput" placeholder="Nama Platform Baru"
                               class="flex-grow px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        <button id="addPlatformOptionButton"
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                            Tambah
                        </button>
                    </div>
                    <div class="mt-4">
                        <h4 class="text-md font-semibold text-gray-700 mb-2">Opsi Kustom Saat Ini:</h4>
                        <ul id="currentPlatformOptionsList" class="list-disc list-inside text-sm text-gray-600">
                            <!-- Custom platforms will be rendered here -->
                        </ul>
                    </div>
                </div>

                <!-- Add Store Option -->
                <div class="p-4 bg-gray-50 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Tambah Opsi Platform Digital</h3>
                    <div class="flex flex-col sm:flex-row gap-2 mb-2">
                        <input type="text" id="storeOptionInput" placeholder="Nama Toko Baru"
                               class="flex-grow px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        <button id="addStoreOptionButton"
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                            Tambah
                        </button>
                    </div>
                    <div class="mt-4">
                        <h4 class="text-md font-semibold text-gray-700 mb-2">Opsi Kustom Saat Ini:</h4>
                        <ul id="currentStoreOptionsList" class="list-disc list-inside text-sm text-gray-600">
                            <!-- Custom stores will be rendered here -->
                        </ul>
                    </div>
                </div>

                <!-- Add Lokasi Option -->
                <div class="p-4 bg-gray-50 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Tambah Opsi Mentahan</h3>
                    <div class="flex flex-col sm:flex-row gap-2 mb-2">
                        <input type="text" id="lokasiOptionInput" placeholder="Nama Lokasi Baru"
                               class="flex-grow px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        <button id="addLokasiOptionButton"
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                            Tambah
                        </button>
                    </div>
                    <div class="mt-4">
                        <h4 class="text-md font-semibold text-gray-700 mb-2">Opsi Kustom Saat Ini:</h4>
                        <ul id="currentLokasiOptionsList" class="list-disc list-inside text-sm text-gray-600">
                            <!-- Custom locations will be rendered here -->
                        </ul>
                    </div>
                </div>

                <!-- Add Status Option -->
                <div class="p-4 bg-gray-50 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Tambah Opsi Status</h3>
                    <div class="flex flex-col sm:flex-row gap-2 mb-2">
                        <input type="text" id="statusOptionInput" placeholder="Nama Status Baru"
                               class="flex-grow px-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                        <button id="addStatusOptionButton"
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                            Tambah
                        </button>
                    </div>
                    <div class="mt-4">
                        <h4 class="text-md font-semibold text-gray-700 mb-2">Opsi Kustom Saat Ini:</h4>
                        <ul id="currentStatusOptionsList" class="list-disc list-inside text-sm text-gray-600">
                            <!-- Custom statuses will be rendered here -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Custom Modal for Confirmation -->
    <div id="customModal" class="modal">
        <div class="modal-content">
            <p id="modalMessage" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="modalConfirmYes" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">Ya</button>
                <button id="modalConfirmNo" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">Tidak</button>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Messages -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <p id="messageModalText" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <button id="messageModalClose" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">OK</button>
        </div>
    </div>


    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, setDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js"; // Import getAnalytics

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let analytics; // Deklarasi variabel analytics
        let userId = null;
        let authReady = false; // Flag to indicate if authentication is ready

        // Getting Canvas environment variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const canvasFirebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Fallback Firebase configuration (from your original provided script)
        const fallbackFirebaseConfig = {
            apiKey: "AIzaSyAzJTL179V9bT-DfefZq9gcG8Tz88VzLmQ",
            authDomain: "koleksi-game.firebaseapp.com",
            projectId: "koleksi-game",
            storageBucket: "koleksi-game.firebasestorage.app",
            messagingSenderId: "222959670551",
            appId: "1:222959670551:web:048b1e2c4ef16b7bd31352",
            measurementId: "G-BYYCM7R4M8"
        };

        // Determine which firebaseConfig to use
        const currentFirebaseConfig = canvasFirebaseConfig.projectId ? canvasFirebaseConfig : fallbackFirebaseConfig;
        console.log("Menggunakan konfigurasi Firebase:", currentFirebaseConfig);


        // Initialize Firebase
        function initializeFirebase() {
            try {
                app = initializeApp(currentFirebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                analytics = getAnalytics(app); // Inisialisasi Analytics

                // Authenticate user
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = `ID Pengguna: ${userId}`;
                        authReady = true;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        // Start loading data after auth is ready
                        await loadAllDataFromFirestore();
                        showTab('game-list'); // Show initial tab after data loads
                    } else {
                        // Sign in anonymously if no token or user not logged in
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            displayMessage("Gagal otentikasi dengan Firebase: " + error.message, "error");
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                displayMessage("Gagal menginisialisasi Firebase: " + error.message, "error");
            }
        }

        // Mendapatkan referensi elemen DOM
        const gameForm = document.getElementById('gameForm');
        const formTitle = document.getElementById('formTitle');
        const gameTitleInput = document.getElementById('gameTitle');
        const gamePlatformSelect = document.getElementById('gamePlatform');
        const manualPlatformInputContainer = document.getElementById('manualPlatformInputContainer');
        const manualGamePlatformInput = document.getElementById('manualGamePlatform');
        const gameStoreSelect = document.getElementById('gameStore');
        const manualStoreInputContainer = document.getElementById('manualStoreInputContainer');
        const manualGameStoreInput = document.getElementById('manualGameStore');
        const gameStatusSelect = document.getElementById('gameStatus');
        const lokasiMentahanSelect = document.getElementById('lokasiMentahan');
        const manualLokasiMentahanInputContainer = document.getElementById('manualLokasiMentahanInputContainer');
        const manualLokasiMentahanInput = document.getElementById('manualLokasiMentahan');
        const submitButton = document.getElementById('submitButton');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const gameListContainer = document.getElementById('gameList');
        const searchGameInput = document.getElementById('searchGame');
        const filterStatusSelect = document.getElementById('filterStatus');
        const filterPlatformSelect = document.getElementById('filterPlatform');
        const filterLokasiMentahanSelect = document.getElementById('filterLokasiMentahan');
        const sortGamesSelect = document.getElementById('sortGames');
        const noGamesMessage = document.getElementById('noGamesMessage');
        const gameStatusChartCanvas = document.getElementById('gameStatusChart');
        const platformChartCanvas = document.getElementById('platformChart');
        const lokasiMentahanChartCanvas = document.getElementById('lokasiMentahanChart');
        const gameStatusLegend = document.getElementById('gameStatusLegend');
        const platformLegend = document.getElementById('platformLegend');
        const lokasiMentahanLegend = document.getElementById('lokasiMentahanLegend');
        const paginationControls = document.getElementById('paginationControls');

        // Elements for file operations and auto-download
        const exportDataButton = document.getElementById('exportDataButton');
        const importDataButton = document.getElementById('importDataButton');
        const importFileInput = document.getElementById('importFileInput');
        const autoDownloadToggle = document.getElementById('autoDownloadToggle');
        const autoDownloadIntervalInput = document.getElementById('autoDownloadInterval');

        // Tab elements
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = {
            'game-list': document.getElementById('game-list'),
            'statistics': document.getElementById('statistics'),
            'data-management': document.getElementById('data-management')
        };

        // New DOM elements for adding dropdown items
        const platformOptionInput = document.getElementById('platformOptionInput');
        const addPlatformOptionButton = document.getElementById('addPlatformOptionButton');
        const currentPlatformOptionsList = document.getElementById('currentPlatformOptionsList');

        const storeOptionInput = document.getElementById('storeOptionInput');
        const addStoreOptionButton = document.getElementById('addStoreOptionButton');
        const currentStoreOptionsList = document.getElementById('currentStoreOptionsList');

        const lokasiOptionInput = document.getElementById('lokasiOptionInput');
        const addLokasiOptionButton = document.getElementById('addLokasiOptionButton');
        const currentLokasiOptionsList = document.getElementById('currentLokasiOptionsList');

        const statusOptionInput = document.getElementById('statusOptionInput');
        const addStatusOptionButton = document.getElementById('addStatusOptionButton');
        const currentStatusOptionsList = document.getElementById('currentStatusOptionsList');

        // Custom Modal elements
        const customModal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalConfirmYes = document.getElementById('modalConfirmYes');
        const modalConfirmNo = document.getElementById('modalConfirmNo');
        const messageModal = document.getElementById('messageModal');
        const messageModalText = document.getElementById('messageModalText');
        const messageModalClose = document.getElementById('messageModalClose');


        // Array untuk menyimpan koleksi game (akan diisi dari Firestore)
        let games = [];
        // Variabel untuk melacak game yang sedang diedit (Firestore doc ID)
        let editingGameId = null;

        // Variabel untuk pagination
        const gamesPerPage = 6;
        let currentPage = 1;

        // Instansi Chart.js
        let gameStatusPieChart = null;
        let platformPieChart = null;
        let lokasiMentahanPieChart = null;

        // Auto-download interval ID
        let autoDownloadIntervalId = null;
        let currentAutoDownloadInterval = 5; // Default 5 minutes

        // Default options for dropdowns (not including 'manual' option)
        const defaultPlatforms = ['PC', 'PS', 'PS2', 'PS3'];
        const defaultStores = ['Steam', 'Epic Games', 'GOG'];
        const defaultStatuses = ['Dimainkan', 'Belum Dimainkan', 'Selesai', 'Wishlist'];
        const defaultLokasiMentahanOptions = ['HDD Eksternal 4TB', 'HDD Eksternal 2TB'];

        // Custom options loaded/saved to Firestore
        let customPlatforms = [];
        let customStores = [];
        let customLocations = [];
        let customStatuses = [];

        // --- Firestore Functions ---

        // Helper to get collection paths
        function getGamesCollectionRef() {
            if (!userId) {
                console.error("User ID not available for Firestore operations.");
                return null;
            }
            return collection(db, `artifacts/${appId}/users/${userId}/games`);
        }

        function getCustomOptionsDocRef() {
            if (!userId) {
                console.error("User ID not available for Firestore operations.");
                return null;
            }
            return doc(db, `artifacts/${appId}/users/${userId}/app_data/custom_options`);
        }

        // Load all data from Firestore (games and custom options)
        async function loadAllDataFromFirestore() {
            if (!authReady) {
                console.warn("Firestore not ready. Authentication not complete.");
                return;
            }

            console.log("Memuat data game dari Firestore...");
            const gamesColRef = getGamesCollectionRef();
            if (gamesColRef) {
                onSnapshot(gamesColRef, (snapshot) => {
                    const loadedGames = [];
                    snapshot.forEach(doc => {
                        loadedGames.push({ id: doc.id, ...doc.data() });
                    });
                    games = loadedGames;
                    console.log("Games loaded from Firestore:", games);
                    currentPage = 1; // Reset page on data update
                    renderAll();
                }, (error) => {
                    console.error("Error getting real-time game updates:", error);
                    displayMessage("Gagal memuat game dari database: " + error.message, "error");
                });
            }

            console.log("Memuat opsi kustom dari Firestore...");
            const customOptionsDocRef = getCustomOptionsDocRef();
            if (customOptionsDocRef) {
                onSnapshot(customOptionsDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        customPlatforms = data.platforms || [];
                        customStores = data.stores || [];
                        customLocations = data.locations || [];
                        customStatuses = data.statuses || [];
                        console.log("Custom options loaded from Firestore:", data);
                    } else {
                        console.log("No custom options found, using defaults.");
                        customPlatforms = [];
                        customStores = [];
                        customLocations = [];
                        customStatuses = [];
                    }
                    updateAllDropdowns(); // Update UI after custom options load
                }, (error) => {
                    console.error("Error getting real-time custom options updates:", error);
                    displayMessage("Gagal memuat opsi kustom dari database: " + error.message, "error");
                });
            }

            // Muat status auto-download dan interval dari localStorage (tetap di localStorage)
            const autoDownloadEnabled = localStorage.getItem('autoDownloadEnabled') === 'true';
            const storedInterval = localStorage.getItem('autoDownloadInterval');
            if (storedInterval) {
                currentAutoDownloadInterval = parseInt(storedInterval);
            }
            autoDownloadIntervalInput.value = currentAutoDownloadInterval;
            autoDownloadToggle.checked = autoDownloadEnabled;
            toggleAutoDownload(autoDownloadEnabled, currentAutoDownloadInterval); // Pass current interval
        }

        // Save custom dropdown options to Firestore
        async function saveCustomDropdownOptionsToFirestore() {
            if (!authReady) {
                displayMessage("Aplikasi belum siap. Harap tunggu otentikasi selesai.", "error");
                return false;
            }
            const customOptionsDocRef = getCustomOptionsDocRef();
            if (!customOptionsDocRef) return false;

            try {
                await setDoc(customOptionsDocRef, {
                    platforms: customPlatforms,
                    stores: customStores,
                    locations: customLocations,
                    statuses: customStatuses
                }, { merge: true });
                console.log("Custom options saved to Firestore.");
                return true;
            } catch (e) {
                console.error("Error saving custom options to Firestore:", e);
                displayMessage("Gagal menyimpan opsi kustom: " + e.message, "error");
                return false;
            }
        }

        // --- Generic function to populate a select element ---
        function populateSelect(selectElement, optionsArray, includeManual = true, addPlaceholder = false) {
            selectElement.innerHTML = '';
            if (addPlaceholder) {
                const placeholderOption = document.createElement('option');
                placeholderOption.value = "";
                placeholderOption.textContent = "Pilih Lokasi"; // Placeholder for Lokasi dropdown
                selectElement.appendChild(placeholderOption);
            }
            optionsArray.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
            if (includeManual) {
                const manualOpt = document.createElement('option');
                manualOpt.value = 'manual';
                manualOpt.textContent = 'Lainnya (input manual)';
                selectElement.appendChild(manualOpt);
            }
        }

        // --- Render custom options list in Data Management tab ---
        function renderCustomOptionsList(optionsArray, listElement) {
            listElement.innerHTML = '';
            if (optionsArray.length === 0) {
                listElement.innerHTML = '<li class="text-gray-500">Belum ada opsi kustom.</li>';
                return;
            }
            optionsArray.forEach(option => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center py-1';
                li.innerHTML = `
                    <span>${option}</span>
                    <button data-value="${option}" class="delete-custom-option-button text-red-500 hover:text-red-700 text-sm font-bold ml-2">Hapus</button>
                `;
                listElement.appendChild(li);
            });
        }

        // --- Update all relevant dropdowns with default and custom options ---
        function updateAllDropdowns() {
            // Combine default and custom options for each category
            const allPlatforms = [...new Set([...defaultPlatforms, ...customPlatforms])].sort();
            const allStores = [...new Set([...defaultStores, ...customStores])].sort();
            const allStatuses = [...new Set([...defaultStatuses, ...customStatuses])].sort();
            const allLokasiMentahan = [...new Set([...defaultLokasiMentahanOptions, ...customLocations])].sort();

            // Populate game form dropdowns
            populateSelect(gamePlatformSelect, allPlatforms, true);
            populateSelect(gameStoreSelect, allStores, true);
            populateSelect(gameStatusSelect, allStatuses, false); // Status dropdown doesn't have 'manual'
            populateSelect(lokasiMentahanSelect, allLokasiMentahan, true, true); // Lokasi has placeholder and manual

            // Populate filter dropdowns (they don't need 'manual' option)
            populateSelect(filterPlatformSelect, ['all', ...allPlatforms], false); // 'all' option handled
            populateSelect(filterStatusSelect, ['all', ...allStatuses], false);
            populateSelect(filterLokasiMentahanSelect, ['all', ...allLokasiMentahan], false);

            // Render custom options lists in data management tab
            renderCustomOptionsList(customPlatforms, currentPlatformOptionsList);
            renderCustomOptionsList(customStores, currentStoreOptionsList);
            renderCustomOptionsList(customLocations, currentLokasiOptionsList);
            renderCustomOptionsList(customStatuses, currentStatusOptionsList);

            // Restore previously selected values for filters if available
            filterPlatformSelect.value = filterPlatformSelect.dataset.currentValue || 'all';
            filterLokasiMentahanSelect.value = filterLokasiMentahanSelect.dataset.currentValue || 'all';
            filterStatusSelect.value = filterStatusSelect.dataset.currentValue || 'all'; // Also for status filter
        }

        // --- Generic add custom option logic ---
        async function handleAddCustomOption(inputElement, customArray, listElement) {
            if (!authReady) {
                displayMessage("Aplikasi belum siap. Harap tunggu otentikasi selesai.", "error");
                return;
            }

            const newItem = inputElement.value.trim();
            if (newItem && !customArray.includes(newItem)) {
                customArray.push(newItem);
                if (await saveCustomDropdownOptionsToFirestore()) {
                    displayMessage(`${newItem} berhasil ditambahkan!`, "success");
                    inputElement.value = '';
                    updateAllDropdowns(); // Re-populate all dropdowns and lists
                }
            } else if (customArray.includes(newItem)) {
                displayMessage(`"${newItem}" sudah ada.`, "error");
            } else {
                displayMessage("Harap masukkan nama opsi.", "error");
            }
        }

        // --- Generic delete custom option logic ---
        function handleDeleteCustomOption(event, customArray) {
            if (!authReady) {
                displayMessage("Aplikasi belum siap. Harap tunggu otentikasi selesai.", "error");
                return;
            }

            const itemToDelete = event.target.dataset.value;
            displayConfirmation(`Apakah Anda yakin ingin menghapus "${itemToDelete}"?`, async () => {
                const index = customArray.indexOf(itemToDelete);
                if (index > -1) {
                    customArray.splice(index, 1);
                    if (await saveCustomDropdownOptionsToFirestore()) {
                        displayMessage(`"${itemToDelete}" berhasil dihapus.`, "success");
                        updateAllDropdowns(); // Re-populate all dropdowns and lists
                    }
                }
            });
        }

        // Fungsi untuk merender (menampilkan) daftar game, menerapkan filter dan pengurutan
        function renderGames() {
            gameListContainer.innerHTML = ''; // Mengosongkan daftar yang ada
            const searchTerm = searchGameInput.value.toLowerCase();
            const filterStatus = filterStatusSelect.value;
            const filterPlatform = filterPlatformSelect.value;
            const filterLokasiMentahan = filterLokasiMentahanSelect.value;
            const sortOption = sortGamesSelect.value;

            // Filter game berdasarkan pencarian dan status
            let filteredGames = games.filter(game => {
                const matchesSearch = game.title.toLowerCase().includes(searchTerm) ||
                                      game.platform.toLowerCase().includes(searchTerm) ||
                                      game.store.toLowerCase().includes(searchTerm);
                const matchesStatus = filterStatus === 'all' || game.status === filterStatus;
                const matchesPlatform = filterPlatform === 'all' || game.platform === filterPlatform;
                const matchesLokasiMentahan = filterLokasiMentahan === 'all' || game.lokasiMentahan === filterLokasiMentahan;
                return matchesSearch && matchesStatus && matchesPlatform && matchesLokasiMentahan;
            });

            // Urutkan game
            filteredGames.sort((a, b) => {
                switch (sortOption) {
                    case 'title-asc':
                        return a.title.localeCompare(b.title);
                    case 'title-desc':
                        return b.title.localeCompare(a.title);
                    case 'platform-asc':
                        return a.platform.localeCompare(b.platform);
                    case 'status-asc':
                        return a.status.localeCompare(b.status);
                    default:
                        return 0;
                }
            });

            // Terapkan pagination
            const totalPages = Math.ceil(filteredGames.length / gamesPerPage);
            const startIndex = (currentPage - 1) * gamesPerPage;
            const endIndex = startIndex + gamesPerPage;
            const gamesToDisplay = filteredGames.slice(startIndex, endIndex);

            if (gamesToDisplay.length === 0) {
                noGamesMessage.classList.remove('hidden');
                // Pastikan kelas grid dihapus jika tidak ada game
                gameListContainer.classList.remove('grid', 'grid-cols-1', 'sm:grid-cols-2', 'md:grid-cols-3', 'gap-4');
                gameListContainer.classList.add('space-y-4'); // Tambahkan kembali space-y-4 untuk konsistensi jika kosong
            } else {
                noGamesMessage.classList.add('hidden');
                // Terapkan tata letak grid untuk 3 kolom pada layar sedang dan lebih besar
                gameListContainer.classList.remove('space-y-4');
                gameListContainer.classList.add('grid', 'grid-cols-1', 'sm:grid-cols-2', 'md:grid-cols-3', 'gap-4');

                gamesToDisplay.forEach(game => {
                    const gameItem = document.createElement('div');
                    gameItem.className = 'bg-gray-50 p-4 rounded-md shadow-sm flex flex-col items-start justify-between';

                    gameItem.innerHTML = `
                        <div class="flex-grow w-full mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">${game.title}</h3>
                            <p class="text-sm text-gray-600">Platform: ${game.platform}</p>
                            <p class="text-sm text-gray-600">Toko: ${game.store}</p>
                            <p class="text-sm text-gray-600">Lokasi: ${game.lokasiMentahan || '-'}</p>
                            <span class="inline-block px-3 py-1 text-xs font-medium rounded-full ${getStatusColorClass(game.status)}">
                                ${game.status}
                            </span>
                        </div>
                        <div class="flex space-x-2 mt-auto"> <!-- mt-auto mendorong tombol ke bagian bawah -->
                            <button data-id="${game.id}"
                                    class="edit-button bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-md transition duration-300 ease-in-out transform hover:scale-105">
                                Edit
                            </button>
                            <button data-id="${game.id}"
                                    class="delete-button bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md transition duration-300 ease-in-out transform hover:scale-105">
                                Hapus
                            </button>
                        </div>
                    `;
                    gameListContainer.appendChild(gameItem);
                });
            }

            // Render kontrol paginasi
            renderPaginationControls(totalPages);
        }

        // Fungsi untuk merender kontrol paginasi
        function renderPaginationControls(totalPages) {
            paginationControls.innerHTML = ''; // Kosongkan kontrol yang ada

            if (totalPages <= 1) {
                return; // Jangan tampilkan paginasi jika hanya ada satu halaman atau kurang
            }

            // Tombol Sebelumnya
            const prevButton = document.createElement('button');
            prevButton.textContent = 'Sebelumnya';
            prevButton.className = `px-4 py-2 rounded-md transition duration-300 ${currentPage === 1 ? 'bg-gray-300 text-gray-600 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600 text-white'}`;
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderGames();
                }
            });
            paginationControls.appendChild(prevButton);

            // Nomor Halaman
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = `px-4 py-2 rounded-md transition duration-300 ${currentPage === i ? 'bg-blue-700 text-white font-bold' : 'bg-gray-200 hover:bg-gray-300 text-gray-800'}`;
                pageButton.addEventListener('click', () => {
                    currentPage = i;
                    renderGames();
                });
                paginationControls.appendChild(pageButton);
            }

            // Tombol Berikutnya
            const nextButton = document.createElement('button');
            nextButton.textContent = 'Berikutnya';
            nextButton.className = `px-4 py-2 rounded-md transition duration-300 ${currentPage === totalPages ? 'bg-gray-300 text-gray-600 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600 text-white'}`;
            nextButton.disabled = currentPage === totalPages;
            nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderGames();
                }
            });
            paginationControls.appendChild(nextButton);
        }

        // Fungsi pembantu untuk mendapatkan warna status
        function getStatusColorClass(status) {
            switch (status) {
                case 'Dimainkan':
                    return 'bg-emerald-200 text-emerald-800'; // Brighter green
                case 'Belum Dimainkan':
                    return 'bg-orange-200 text-orange-800'; // Vibrant orange
                case 'Selesai':
                    return 'bg-sky-200 text-sky-800'; // Richer blue
                case 'Wishlist':
                    return 'bg-fuchsia-200 text-fuchsia-800'; // Deeper fuchsia/purple
                default:
                    return 'bg-gray-300 text-gray-800'; // Slightly darker gray
            }
        }

        // Fungsi untuk merender statistik koleksi
        function renderStatistics() {
            const totalGames = games.length;

            const statusCounts = games.reduce((acc, game) => {
                acc[game.status] = (acc[game.status] || 0) + 1;
                return acc;
            }, {});

            const platformCounts = games.reduce((acc, game) => {
                const platforms = game.platform.split(',').map(p => p.trim());
                platforms.forEach(p => {
                    if (p) {
                        acc[p] = (acc[p] || 0) + 1;
                    }
                });
                return acc;
            }, {});

            const lokasiMentahanCounts = games.reduce((acc, game) => {
                if (game.lokasiMentahan) {
                    acc[game.lokasiMentahan] = (acc[game.lokasiMentahan] || 0) + 1;
                }
                return acc;
            }, {});

            // Data untuk Chart Status Game
            const statusLabels = Object.keys(statusCounts);
            const statusData = Object.values(statusCounts);
            const statusColors = statusLabels.map(status => {
                switch (status) {
                    case 'Dimainkan': return 'rgb(16, 185, 129)'; // emerald-500
                    case 'Belum Dimainkan': return 'rgb(249, 115, 22)'; // orange-500
                    case 'Selesai': return 'rgb(14, 165, 233)'; // sky-500
                    case 'Wishlist': return 'rgb(192, 38, 211)'; // fuchsia-500
                    default: return 'rgb(156, 163, 175)'; // gray-400
                }
            });

            // Data untuk Chart Platform
            const platformLabels = Object.keys(platformCounts);
            const platformData = Object.values(platformCounts);
            const platformColors = platformLabels.map((_, i) => `hsl(${i * 60}, 70%, 60%)`);

            // Data untuk Chart Lokasi
            const lokasiMentahanLabels = Object.keys(lokasiMentahanCounts);
            const lokasiMentahanData = Object.values(lokasiMentahanCounts);
            const lokasiMentahanColors = lokasiMentahanLabels.map((_, i) => `hsl(${i * 90 + 30}, 80%, 50%)`); // Different hue for distinction

            // Hancurkan chart yang ada jika ada
            if (gameStatusPieChart) {
                gameStatusPieChart.destroy();
            }
            if (platformPieChart) {
                platformPieChart.destroy();
            }
            if (lokasiMentahanPieChart) {
                lokasiMentahanPieChart.destroy();
            }

            // Inisialisasi Chart Status Game
            gameStatusPieChart = new Chart(gameStatusChartCanvas, {
                type: 'pie',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        data: statusData,
                        backgroundColor: statusColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false,
                            text: 'Statistik Game Berdasarkan Status'
                        }
                    }
                }
            });

            // Buat legend kustom untuk status
            gameStatusLegend.innerHTML = `
                <div class="flex flex-wrap justify-center gap-x-4 gap-y-2">
                    <div class="flex items-center">
                        <span class="inline-block w-3 h-3 rounded-full bg-blue-200 mr-2"></span>
                        <span class="text-gray-700 font-semibold">Total Game: ${totalGames}</span>
                    </div>
                    ${statusLabels.map((label, index) => `
                        <div class="flex items-center">
                            <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${statusColors[index]};"></span>
                            <span class="ml-2 text-gray-700">${label}: ${statusData[index]}</span>
                        </div>
                    `).join('')}
                </div>
            `;

            // Inisialisasi Chart Platform
            platformPieChart = new Chart(platformChartCanvas, {
                type: 'pie',
                data: {
                    labels: platformLabels,
                    datasets: [{
                        data: platformData,
                        backgroundColor: platformColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false,
                            text: 'Statistik Platform'
                        }
                    }
                }
            });

            // Buat legend kustom untuk platform
            platformLegend.innerHTML = `
                <div class="flex flex-wrap justify-center gap-x-4 gap-y-2">
                    ${platformLabels.map((label, index) => `
                        <div class="flex items-center">
                            <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${platformColors[index]};"></span>
                            <span class="ml-2 text-gray-700">${label}: ${platformData[index]}</span>
                        </div>
                    `).join('')}
                </div>
            `;

            // Inisialisasi Chart Lokasi
            lokasiMentahanPieChart = new Chart(lokasiMentahanChartCanvas, {
                type: 'pie',
                data: {
                    labels: lokasiMentahanLabels,
                    datasets: [{
                        data: lokasiMentahanData,
                        backgroundColor: lokasiMentahanColors,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false,
                            text: 'Statistik Lokasi'
                        }
                    }
                }
            });

            // Buat legend kustom untuk lokasi
            lokasiMentahanLegend.innerHTML = `
                <div class="flex flex-wrap justify-center gap-x-4 gap-y-2">
                    ${lokasiMentahanLabels.map((label, index) => `
                        <div class="flex items-center">
                            <span class="inline-block w-3 h-3 rounded-full" style="background-color: ${lokasiMentahanColors[index]};"></span>
                            <span class="ml-2 text-gray-700">${label}: ${lokasiMentahanData[index]}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }


        // Event listener untuk submit form (Tambah/Update Game)
        gameForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Mencegah refresh halaman

            if (!authReady) {
                displayMessage("Aplikasi belum siap. Harap tunggu otentikasi selesai.", "error");
                return;
            }

            let selectedStore = gameStoreSelect.value;
            if (selectedStore === 'manual') {
                selectedStore = manualGameStoreInput.value.trim();
                if (!selectedStore) {
                    displayMessage("Harap masukkan nama toko manual.", "error");
                    return;
                }
            }

            let selectedPlatform = gamePlatformSelect.value;
            if (selectedPlatform === 'manual') {
                selectedPlatform = manualGamePlatformInput.value.trim();
                if (!selectedPlatform) {
                    displayMessage("Harap masukkan nama platform manual.", "error");
                    return;
                }
            }

            let selectedLokasiMentahan = lokasiMentahanSelect.value;
            if (selectedLokasiMentahan === 'manual') {
                selectedLokasiMentahan = manualLokasiMentahanInput.value.trim();
                if (!selectedLokasiMentahan) {
                    displayMessage("Harap masukkan nama lokasi manual.", "error");
                    return;
                }
            }

            const gameData = {
                title: gameTitleInput.value.trim(),
                platform: selectedPlatform,
                store: selectedStore,
                status: gameStatusSelect.value,
                lokasiMentahan: selectedLokasiMentahan, // Menggunakan nilai dari dropdown atau input manual
            };

            if (gameData.title && gameData.platform && gameData.store) {
                try {
                    if (editingGameId !== null) {
                        // Update existing game in Firestore
                        const gameDocRef = doc(db, `artifacts/${appId}/users/${userId}/games`, editingGameId);
                        await updateDoc(gameDocRef, gameData);
                        displayMessage("Game berhasil diperbarui!", "success");
                    } else {
                        // Add new game to Firestore
                        const gamesColRef = getGamesCollectionRef();
                        if (gamesColRef) {
                            await addDoc(gamesColRef, gameData);
                            displayMessage("Game berhasil ditambahkan!", "success");
                        }
                    }
                    gameForm.reset();
                    manualStoreInputContainer.classList.add('hidden');
                    manualGameStoreInput.value = '';
                    manualPlatformInputContainer.classList.add('hidden');
                    manualGamePlatformInput.value = '';
                    manualLokasiMentahanInputContainer.classList.add('hidden');
                    manualLokasiMentahanInput.value = '';
                    editingGameId = null;
                    formTitle.textContent = "Tambah Game Baru";
                    submitButton.textContent = "Tambah Game";
                    cancelEditButton.classList.add('hidden');
                    currentPage = 1; // Reset halaman ke 1 setelah menambahkan/mengedit game
                    // renderAll() will be called by the onSnapshot listener
                } catch (error) {
                    console.error("Error saving game to Firestore:", error);
                    displayMessage("Gagal menyimpan game: " + error.message, "error");
                }
            }
            else {
                displayMessage("Harap isi semua kolom wajib (Judul, Platform, Toko).", "error");
            }
        });

        // Event listener untuk tombol Edit dan Hapus (menggunakan delegasi event)
        gameListContainer.addEventListener('click', async (e) => {
            if (!authReady) {
                displayMessage("Aplikasi belum siap. Harap tunggu otentikasi selesai.", "error");
                return;
            }

            // Tombol Hapus
            if (e.target.classList.contains('delete-button')) {
                const gameIdToDelete = e.target.dataset.id;
                displayConfirmation("Apakah Anda yakin ingin menghapus game ini?", async () => {
                    try {
                        const gameDocRef = doc(db, `artifacts/${appId}/users/${userId}/games`, gameIdToDelete);
                        await deleteDoc(gameDocRef);
                        displayMessage("Game berhasil dihapus!", "success");
                        currentPage = 1; // Reset halaman ke 1 setelah menghapus game
                        // renderAll() will be called by the onSnapshot listener
                    } catch (error) {
                        console.error("Error deleting game from Firestore:", error);
                        displayMessage("Gagal menghapus game: " + error.message, "error");
                    }
                });
            }
            // Tombol Edit
            else if (e.target.classList.contains('edit-button')) {
                const gameIdToEdit = e.target.dataset.id;
                const gameToEdit = games.find(game => game.id === gameIdToEdit);
                if (gameToEdit) {
                    gameTitleInput.value = gameToEdit.title;

                    // Update dropdowns and manual inputs for editing
                    // Game Platform
                    const allPlatforms = [...defaultPlatforms, ...customPlatforms];
                    if (allPlatforms.includes(gameToEdit.platform)) {
                        gamePlatformSelect.value = gameToEdit.platform;
                        manualPlatformInputContainer.classList.add('hidden');
                        manualGamePlatformInput.value = '';
                    } else {
                        gamePlatformSelect.value = 'manual';
                        manualPlatformInputContainer.classList.remove('hidden');
                        manualGamePlatformInput.value = gameToEdit.platform;
                    }

                    // Game Store
                    const allStores = [...defaultStores, ...customStores];
                    if (allStores.includes(gameToEdit.store)) {
                        gameStoreSelect.value = gameToEdit.store;
                        manualStoreInputContainer.classList.add('hidden');
                        manualGameStoreInput.value = '';
                    } else {
                        gameStoreSelect.value = 'manual';
                        manualStoreInputContainer.classList.remove('hidden');
                        manualGameStoreInput.value = gameToEdit.store;
                    }

                    gameStatusSelect.value = gameToEdit.status;

                    // Lokasi Mentahan
                    const allLokasiMentahan = [...defaultLokasiMentahanOptions, ...customLocations];
                    if (allLokasiMentahan.includes(gameToEdit.lokasiMentahan)) {
                        lokasiMentahanSelect.value = gameToEdit.lokasiMentahan;
                        manualLokasiMentahanInputContainer.classList.add('hidden');
                        manualLokasiMentahanInput.value = '';
                    } else if (gameToEdit.lokasiMentahan) {
                        lokasiMentahanSelect.value = 'manual';
                        manualLokasiMentahanInputContainer.classList.remove('hidden');
                        manualLokasiMentahanInput.value = gameToEdit.lokasiMentahan;
                    } else {
                        lokasiMentahanSelect.value = '';
                        manualLokasiMentahanInputContainer.classList.add('hidden');
                        manualLokasiMentahanInput.value = '';
                    }

                    editingGameId = gameIdToEdit;
                    formTitle.textContent = "Edit Game";
                    submitButton.textContent = "Update Game";
                    cancelEditButton.classList.remove('hidden');

                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            }
        });

        // Event listener untuk tombol Batal Edit
        cancelEditButton.addEventListener('click', () => {
            editingGameId = null;
            gameForm.reset();
            formTitle.textContent = "Tambah Game Baru";
            submitButton.textContent = "Tambah Game";
            cancelEditButton.classList.add('hidden');
            manualStoreInputContainer.classList.add('hidden');
            manualGameStoreInput.value = '';
            manualPlatformInputContainer.classList.add('hidden');
            manualGamePlatformInput.value = '';
            manualLokasiMentahanInputContainer.classList.add('hidden');
            manualLokasiMentahanInput.value = '';
        });

        // Event listener untuk perubahan dropdown Toko/Platform Digital
        gameStoreSelect.addEventListener('change', () => {
            if (gameStoreSelect.value === 'manual') {
                manualStoreInputContainer.classList.remove('hidden');
            } else {
                manualStoreInputContainer.classList.add('hidden');
                manualGameStoreInput.value = '';
            }
        });

        // Event listener untuk perubahan dropdown Platform
        gamePlatformSelect.addEventListener('change', () => {
            if (gamePlatformSelect.value === 'manual') {
                manualPlatformInputContainer.classList.remove('hidden');
            } else {
                manualPlatformInputContainer.classList.add('hidden');
                manualGamePlatformInput.value = '';
            }
        });

        // Event listener for Lokasi dropdown
        lokasiMentahanSelect.addEventListener('change', () => {
            if (lokasiMentahanSelect.value === 'manual') {
                manualLokasiMentahanInputContainer.classList.remove('hidden');
            } else {
                manualLokasiMentahanInputContainer.classList.add('hidden');
                manualLokasiMentahanInput.value = '';
            }
        });

        // Event listener untuk pencarian, filter, dan pengurutan
        searchGameInput.addEventListener('input', () => {
            currentPage = 1; // Reset halaman saat pencarian berubah
            renderGames();
        });
        filterStatusSelect.addEventListener('change', () => {
            currentPage = 1; // Reset halaman saat filter berubah
            renderGames();
        });
        sortGamesSelect.addEventListener('change', () => {
            currentPage = 1; // Reset halaman saat pengurutan berubah
            renderGames();
        });

        // New filter event listeners
        filterPlatformSelect.addEventListener('change', () => {
            filterPlatformSelect.dataset.currentValue = filterPlatformSelect.value;
            currentPage = 1; // Reset halaman saat filter berubah
            renderGames();
        });
        filterLokasiMentahanSelect.addEventListener('change', () => {
            filterLokasiMentahanSelect.dataset.currentValue = filterLokasiMentahanSelect.value;
            currentPage = 1; // Reset halaman saat filter berubah
            renderGames();
        });

        // Fungsi untuk menampilkan pesan kustom (mengganti alert)
        function displayMessage(message, type) {
            messageModalText.textContent = message;
            messageModalText.className = `text-lg font-semibold mb-4 ${type === 'error' ? 'text-red-800' : 'text-green-800'}`;
            messageModal.style.display = 'flex'; // Show modal

            messageModalClose.onclick = () => {
                messageModal.style.display = 'none'; // Hide modal
            };

            // Optional: Auto-hide after some time for success messages
            if (type === 'success') {
                setTimeout(() => {
                    messageModal.style.display = 'none';
                }, 3000);
            }
        }

        // Fungsi untuk menampilkan konfirmasi kustom (mengganti confirm)
        function displayConfirmation(message, onConfirm) {
            modalMessage.textContent = message;
            customModal.style.display = 'flex'; // Show modal

            const handleYes = () => {
                onConfirm();
                customModal.style.display = 'none';
                modalConfirmYes.removeEventListener('click', handleYes);
                modalConfirmNo.removeEventListener('click', handleNo);
            };

            const handleNo = () => {
                customModal.style.display = 'none';
                modalConfirmYes.removeEventListener('click', handleYes);
                modalConfirmNo.removeEventListener('click', handleNo);
            };

            modalConfirmYes.addEventListener('click', handleYes);
            modalConfirmNo.addEventListener('click', handleNo);
        }

        // Fungsi untuk merender semua komponen yang perlu diperbarui
        function renderAll() {
            renderGames();
            updateAllDropdowns(); // Re-populate all dropdowns including custom options and filter options
        }

        // --- Fitur Ekspor Data ke File JSON (digunakan untuk auto-download) ---
        function exportData() {
            const dataStr = JSON.stringify(games, null, 2); // Indentasi 2 spasi untuk keterbacaan
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'game_collection.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            displayMessage("Data game berhasil diunduh!", "success");
        }

        exportDataButton.addEventListener('click', exportData); // Menggunakan fungsi exportData

        // --- Fitur Impor Data dari File JSON ---
        importDataButton.addEventListener('click', () => {
            importFileInput.click(); // Trigger klik pada input file tersembunyi
        });

        importFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    if (!authReady) {
                        displayMessage("Aplikasi belum siap. Harap tunggu otentikasi selesai.", "error");
                        return;
                    }
                    try {
                        const importedGames = JSON.parse(e.target.result);
                        // Validasi sederhana: pastikan ini adalah array dan setiap item memiliki setidaknya 'title'
                        if (Array.isArray(importedGames) && importedGames.every(g => g.title)) {
                            displayConfirmation("Mengimpor data akan menimpa koleksi game Anda saat ini di database. Lanjutkan?", async () => {
                                const gamesColRef = getGamesCollectionRef();
                                if (!gamesColRef) return;

                                try {
                                    // Delete all existing games
                                    const snapshot = await getDocs(query(gamesColRef));
                                    const batch = db.batch(); // Firestore batch for multiple writes
                                    snapshot.forEach((doc) => {
                                        batch.delete(doc.ref);
                                    });
                                    await batch.commit();
                                    console.log("Existing games deleted.");

                                    // Add imported games
                                    const addBatch = db.batch();
                                    importedGames.forEach((game) => {
                                        // Ensure unique IDs if needed, Firestore addDoc generates ID
                                        const newDocRef = doc(gamesColRef); // Let Firestore generate ID
                                        addBatch.set(newDocRef, game); // Use setDoc with a generated ID
                                    });
                                    await addBatch.commit();

                                    displayMessage("Data game berhasil diimpor dan diperbarui di database!", "success");
                                    currentPage = 1;
                                    // renderAll will be called by onSnapshot
                                } catch (error) {
                                    console.error("Error importing and saving to Firestore:", error);
                                    displayMessage("Gagal mengimpor data ke database: " + error.message, "error");
                                }
                            });
                        } else {
                            displayMessage("Format file JSON tidak valid. Pastikan berisi array objek game dengan setidaknya 'judul'.", "error");
                        }
                    } catch (error) {
                        displayMessage("Gagal membaca atau mengurai file JSON. Pastikan formatnya benar.", "error");
                        console.error("Error importing file:", error);
                    }
                };
                reader.readAsText(file);
            }
        });

        // --- Fitur Auto-download ---
        function toggleAutoDownload(enable, intervalMinutes) {
            if (autoDownloadIntervalId) {
                clearInterval(autoDownloadIntervalId); // Clear any existing interval
                autoDownloadIntervalId = null;
            }

            if (enable && intervalMinutes && intervalMinutes > 0) {
                const intervalMs = intervalMinutes * 60 * 1000;
                autoDownloadIntervalId = setInterval(() => {
                    exportData(); // Call the download function
                }, intervalMs);
                console.log(`Auto-download diaktifkan setiap ${intervalMinutes} menit.`);
                displayMessage(`Auto-download diaktifkan setiap ${intervalMinutes} menit!`, "success");
            } else if (enable && (!intervalMinutes || intervalMinutes <= 0)) {
                displayMessage("Interval auto-download harus lebih dari 0 menit.", "error");
                autoDownloadToggle.checked = false; // Uncheck if invalid interval
            } else {
                console.log("Auto-download dinonaktifkan.");
                displayMessage("Auto-download dinonaktifkan.", "success");
            }
            localStorage.setItem('autoDownloadEnabled', enable);
            localStorage.setItem('autoDownloadInterval', intervalMinutes);
        }

        autoDownloadToggle.addEventListener('change', () => {
            const enable = autoDownloadToggle.checked;
            const interval = parseInt(autoDownloadIntervalInput.value);
            toggleAutoDownload(enable, interval);
        });

        autoDownloadIntervalInput.addEventListener('change', () => {
            const enable = autoDownloadToggle.checked;
            const interval = parseInt(autoDownloadIntervalInput.value);
            if (interval <= 0) {
                displayMessage("Interval harus lebih dari 0.", "error");
                autoDownloadIntervalInput.value = currentAutoDownloadInterval; // Revert to last valid
                return;
            }
            currentAutoDownloadInterval = interval; // Update current interval
            toggleAutoDownload(enable, currentAutoDownloadInterval);
        });


        // --- New Event Listeners for adding custom dropdown items ---
        addPlatformOptionButton.addEventListener('click', () => {
            handleAddCustomOption(platformOptionInput, customPlatforms, currentPlatformOptionsList);
        });
        addStoreOptionButton.addEventListener('click', () => {
            handleAddCustomOption(storeOptionInput, customStores, currentStoreOptionsList);
        });
        addLokasiOptionButton.addEventListener('click', () => {
            handleAddCustomOption(lokasiOptionInput, customLocations, currentLokasiOptionsList);
        });
        addStatusOptionButton.addEventListener('click', () => {
            handleAddCustomOption(statusOptionInput, customStatuses, currentStatusOptionsList);
        });

        // --- New Event Listeners for deleting custom dropdown items (delegation) ---
        currentPlatformOptionsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-custom-option-button')) {
                handleDeleteCustomOption(e, customPlatforms);
            }
        });
        currentStoreOptionsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-custom-option-button')) {
                handleDeleteCustomOption(e, customStores);
            }
        });
        currentLokasiOptionsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-custom-option-button')) {
                handleDeleteCustomOption(e, customLocations);
            }
        });
        currentStatusOptionsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-custom-option-button')) {
                handleDeleteCustomOption(e, customStatuses);
            }
        });

        // --- Tab Functionality ---
        function showTab(tabId) {
            // Sembunyikan semua konten tab dan hapus kelas 'active' dari semua tombol tab
            for (const key in tabContents) {
                if (tabContents.hasOwnProperty(key)) {
                    tabContents[key].classList.add('hidden');
                }
            }
            tabButtons.forEach(button => {
                button.classList.remove('active', 'bg-indigo-700', 'text-white', 'border-b-2', 'border-indigo-700');
                button.classList.add('text-gray-700', 'hover:text-indigo-700');
            });

            // Tampilkan konten tab yang dipilih dan tambahkan kelas 'active' ke tombol yang sesuai
            const selectedTabContent = tabContents[tabId];
            if (selectedTabContent) {
                selectedTabContent.classList.remove('hidden');
            }
            const activeTabButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            if (activeTabButton) {
                activeTabButton.classList.add('active', 'bg-indigo-700', 'text-white', 'border-b-2', 'border-indigo-700');
                activeTabButton.classList.remove('text-gray-700', 'hover:text-indigo-700');
            }

            // Panggil fungsi render yang spesifik untuk tab jika diperlukan
            if (tabId === 'game-list') {
                renderAll(); // Rerender game list, filters, form state
            } else if (tabId === 'statistics') {
                renderStatistics(); // Rerender charts
            } else if (tabId === 'data-management') {
                updateAllDropdowns(); // Ensure custom lists are updated when navigating to this tab
            }
        }

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                showTab(button.dataset.tab);
            });
        });

        // Initialize Firebase when the window loads
        window.onload = initializeFirebase;
    </script>
</body>
</html>
