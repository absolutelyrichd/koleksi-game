<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Koleksi Game</title>
    <style>
        /* CSS Reset & Global Styles */
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #03dac6;
            --primary-variant-color: #3700b3;
            --on-surface-color: #e0e0e0;
            --on-primary-color: #000000;
            --border-color: #333;
            --danger-color: #cf6679;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--on-surface-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            line-height: 1.6;
        }

        /* --- Login View --- */
        #login-view {
            text-align: center;
            padding: 40px;
            background-color: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        #login-view h1 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        #login-view p {
            margin-bottom: 25px;
            color: #aaa;
        }

        .google-btn {
            cursor: pointer;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            background-color: var(--primary-color);
            color: var(--on-primary-color);
            font-size: 16px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.3s ease;
        }

        .google-btn:hover {
            background-color: #018786;
        }

        .google-btn svg {
            width: 20px;
            height: 20px;
        }

        #login-error {
            color: var(--danger-color);
            margin-top: 15px;
            display: none;
        }

        /* --- Dashboard View --- */
        #dashboard-view {
            width: 100%;
            max-width: 1400px;
            height: 95vh;
            display: none; /* Hidden by default */
            flex-direction: column;
            background-color: var(--surface-color);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background-color: rgba(0,0,0,0.2);
            border-bottom: 1px solid var(--border-color);
        }

        header h1 {
            font-size: 24px;
            color: var(--primary-color);
        }

        #user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        #user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        #logout-btn {
            background: var(--danger-color);
            color: var(--on-primary-color);
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        #logout-btn:hover {
            opacity: 0.9;
        }

        /* Main Content */
        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Navigation */
        nav {
            width: 220px;
            padding: 20px;
            border-right: 1px solid var(--border-color);
            background-color: rgba(0,0,0,0.1);
        }

        nav ul {
            list-style: none;
        }

        nav ul li button {
            width: 100%;
            padding: 15px;
            background: none;
            border: none;
            color: var(--on-surface-color);
            text-align: left;
            font-size: 16px;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        nav ul li button.active,
        nav ul li button:hover {
            background-color: var(--primary-color);
            color: var(--on-primary-color);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
        }
        
        .content-tab {
            display: none;
        }

        .content-tab.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        h2 {
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            font-weight: 500;
        }

        /* --- Tab: Daftar Game --- */
        #add-game-btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: var(--on-primary-color);
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: background-color 0.3s ease;
        }
        #add-game-btn:hover {
            background-color: #018786;
        }

        .game-table {
            width: 100%;
            border-collapse: collapse;
        }

        .game-table th, .game-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .game-table th {
            background-color: rgba(0,0,0,0.3);
            font-weight: 600;
        }

        .game-table tbody tr:hover {
            background-color: rgba(255,255,255,0.05);
        }
        
        .status-played { color: #81c784; }
        .status-unplayed { color: #e57373; }

        /* --- Tab: Statistik --- */
        #stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }
        .chart-container {
            background-color: var(--bg-color);
            padding: 20px;
            border-radius: 8px;
        }

        /* --- Tab: Aksi Masal --- */
        #bulk-actions-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        #bulk-actions-form select,
        #bulk-actions-form button {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--surface-color);
            color: var(--on-surface-color);
            font-size: 14px;
        }
        
        #bulk-delete-btn {
            background-color: var(--danger-color);
            color: var(--on-primary-color);
            border: none;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        
        #bulk-delete-btn:hover { opacity: 0.9; }

        /* --- Tab: Manajemen Data --- */
        .data-management-actions button {
            margin-right: 15px;
            margin-bottom: 10px;
            padding: 10px 20px;
            background-color: var(--primary-variant-color);
            color: var(--on-surface-color);
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .data-management-actions button:hover {
            opacity: 0.9;
        }
        .data-management-actions p {
            margin-top: 15px;
            color: #aaa;
            font-size: 14px;
        }

        /* --- Modal Pop-up --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--surface-color);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close-btn {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-content h2 {
            margin-top: 0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--on-surface-color);
            font-size: 16px;
        }

        #save-game-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: var(--on-primary-color);
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        #save-game-btn:hover {
             background-color: #018786;
        }
        
    </style>
</head>
<body>

    <!-- Login View -->
    <div id="login-view">
        <h1>ðŸŽ® Koleksi Game Pribadi</h1>
        <p>Masuk untuk mengelola semua game favoritmu di satu tempat.</p>
        <button id="login-btn" class="google-btn">
            <svg viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
            <span>Masuk dengan Google</span>
        </button>
        <p id="login-error"></p>
    </div>

    <!-- Dashboard View -->
    <div id="dashboard-view">
        <header>
            <h1>Dasbor Game</h1>
            <div id="user-info">
                <span id="user-name"></span>
                <img id="user-photo" src="" alt="Foto Profil">
                <button id="logout-btn">Keluar</button>
            </div>
        </header>
        <main>
            <nav>
                <ul>
                    <li><button class="tab-btn active" data-tab="tab-list">Daftar Game</button></li>
                    <li><button class="tab-btn" data-tab="tab-stats">Statistik</button></li>
                    <li><button class="tab-btn" data-tab="tab-bulk">Aksi Masal</button></li>
                    <li><button class="tab-btn" data-tab="tab-data">Manajemen Data</button></li>
                </ul>
            </nav>
            <section class="content-area">
                <!-- Tab 1: Daftar Game -->
                <div id="tab-list" class="content-tab active">
                    <h2>Koleksi Game Saya</h2>
                    <button id="add-game-btn">+ Tambah Game Baru</button>
                    <div style="overflow-x:auto;">
                        <table class="game-table">
                            <thead>
                                <tr>
                                    <th>Judul Game</th>
                                    <th>Platform</th>
                                    <th>Lokasi</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="game-list-body">
                                <!-- Data game akan dimuat di sini -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tab 2: Statistik -->
                <div id="tab-stats" class="content-tab">
                    <h2>Statistik Koleksi</h2>
                    <div id="stats-container">
                        <div class="chart-container"><canvas id="platform-chart"></canvas></div>
                        <div class="chart-container"><canvas id="location-chart"></canvas></div>
                        <div class="chart-container"><canvas id="status-chart"></canvas></div>
                    </div>
                </div>

                <!-- Tab 3: Aksi Masal -->
                <div id="tab-bulk" class="content-tab">
                    <h2>Aksi Masal</h2>
                    <div id="bulk-actions-form">
                         <select id="filter-platform">
                            <option value="all">Semua Platform</option>
                            <option value="Steam">Steam</option>
                            <option value="Epic">Epic</option>
                            <option value="GOG">GOG</option>
                            <option value="PCSX">PCSX</option>
                            <option value="Crack">Crack</option>
                        </select>
                         <select id="filter-location">
                            <option value="all">Semua Lokasi</option>
                            <option value="HDD Eksternal 2TB">HDD Eksternal 2TB</option>
                            <option value="HDD Eksternal 4TB">HDD Eksternal 4TB</option>
                        </select>
                         <select id="filter-status">
                            <option value="all">Semua Status</option>
                            <option value="Dimainkan">Dimainkan</option>
                            <option value="Belum dimainkan">Belum dimainkan</option>
                        </select>
                        <button id="bulk-delete-btn">Hapus Terpilih</button>
                    </div>
                    <div style="overflow-x:auto;">
                       <table class="game-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="select-all-checkbox"></th>
                                    <th>Judul Game</th>
                                    <th>Platform</th>
                                    <th>Lokasi</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="bulk-game-list-body">
                                <!-- Data game untuk aksi masal -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Tab 4: Manajemen Data -->
                <div id="tab-data" class="content-tab">
                    <h2>Manajemen Data</h2>
                    <div class="data-management-actions">
                        <button id="download-json-btn">Unduh sebagai JSON</button>
                        <button onclick="document.getElementById('upload-json-input').click();">Muat dari JSON</button>
                        <input type="file" id="upload-json-input" accept=".json" style="display: none;">
                        <p><strong>Peringatan:</strong> Memuat file JSON akan menimpa seluruh data koleksi game Anda yang ada saat ini.</p>
                    </div>
                </div>

            </section>
        </main>
    </div>

    <!-- Modal untuk Tambah/Edit Game -->
    <div id="game-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="modal-title">Tambah Game Baru</h2>
            <form id="game-form">
                <input type="hidden" id="game-id">
                <div class="form-group">
                    <label for="game-title">Judul Game</label>
                    <input type="text" id="game-title" required>
                </div>
                <div class="form-group">
                    <label for="game-platform">Platform</label>
                    <select id="game-platform" required>
                        <option value="Steam">Steam</option>
                        <option value="Epic">Epic</option>
                        <option value="GOG">GOG</option>
                        <option value="PCSX">PCSX</option>
                        <option value="Crack">Crack</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="game-location">Lokasi</label>
                    <select id="game-location" required>
                        <option value="HDD Eksternal 2TB">HDD Eksternal 2TB</option>
                        <option value="HDD Eksternal 4TB">HDD Eksternal 4TB</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="game-status">Status</label>
                    <select id="game-status" required>
                        <option value="Belum dimainkan">Belum dimainkan</option>
                        <option value="Dimainkan">Dimainkan</option>
                    </select>
                </div>
                <button type="submit" id="save-game-btn">Simpan</button>
            </form>
        </div>
    </div>
    
    <!-- Chart.js for Statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDK (v9 Modular) -->
    <script type="module">
        // Import fungsi yang diperlukan dari SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            onSnapshot, 
            query, 
            orderBy,
            writeBatch
        } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // Konfigurasi Firebase Anda (dengan storageBucket yang diperbaiki)
        const firebaseConfig = {
            apiKey: "AIzaSyAzJTL179V9bT-DfefZq9gcG8Tz88VzLmQ",
            authDomain: "koleksi-game.firebaseapp.com",
            projectId: "koleksi-game",
            storageBucket: "koleksi-game.appspot.com", // <-- Perbaikan di sini
            messagingSenderId: "222959670551",
            appId: "1:222959670551:web:048b1e2c4ef16b7bd31352",
            measurementId: "G-BYYCM7R4M8"
        };

        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        let currentUser = null;
        let gamesCollectionRef = null;
        let unsubscribeGames = null; // Untuk menghentikan listener saat logout
        let allGamesCache = [];
        let charts = {};

        // === Elemen DOM ===
        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error');
        const userInfo = {
            name: document.getElementById('user-name'),
            photo: document.getElementById('user-photo')
        };
        const gameModal = document.getElementById('game-modal');
        const addGameBtn = document.getElementById('add-game-btn');
        const closeModalBtn = document.querySelector('.close-btn');
        const gameForm = document.getElementById('game-form');

        // === AUTHENTICATION ===
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                // Path ke koleksi game spesifik untuk user ini
                gamesCollectionRef = collection(db, 'users', currentUser.uid, 'games');
                
                loginView.style.display = 'none';
                dashboardView.style.display = 'flex';
                userInfo.name.textContent = currentUser.displayName;
                userInfo.photo.src = currentUser.photoURL;
                
                loadGames();
            } else {
                currentUser = null;
                if (unsubscribeGames) {
                    unsubscribeGames(); // Hentikan listener onSnapshot
                }
                loginView.style.display = 'block';
                dashboardView.style.display = 'none';
                allGamesCache = [];
                Object.values(charts).forEach(chart => chart.destroy());
                charts = {};
            }
        });

        loginBtn.addEventListener('click', () => {
            loginError.style.display = 'none';
            signInWithPopup(auth, googleProvider).catch(error => {
                console.error("Login Error:", error);
                loginError.textContent = `Login Gagal: ${error.message}`;
                loginError.style.display = 'block';
            });
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // === TAB SWITCHING ===
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');
                
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                document.querySelectorAll('.content-tab').forEach(tab => tab.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');

                if (tabId === 'tab-stats') renderStatistics();
                if (tabId === 'tab-bulk') renderBulkActionsList();
            });
        });

        // === MODAL HANDLING ===
        addGameBtn.addEventListener('click', () => {
            gameForm.reset();
            document.getElementById('modal-title').textContent = 'Tambah Game Baru';
            gameModal.style.display = 'flex';
        });

        closeModalBtn.addEventListener('click', () => {
            gameModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target == gameModal) {
                gameModal.style.display = 'none';
            }
        });
        
        // === CRUD OPERATIONS ===
        gameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const gameData = {
                title: document.getElementById('game-title').value,
                platform: document.getElementById('game-platform').value,
                location: document.getElementById('game-location').value,
                status: document.getElementById('game-status').value,
            };
            
            try {
                await addDoc(gamesCollectionRef, gameData);
                console.log('Game berhasil ditambahkan!');
                gameForm.reset();
                gameModal.style.display = 'none';
            } catch (error) {
                console.error('Error adding document: ', error);
                alert('Gagal menambahkan game. Lihat konsol untuk detail.');
            }
        });

        function loadGames() {
            if (!gamesCollectionRef) return;
            
            const q = query(gamesCollectionRef, orderBy('title'));
            
            // Hentikan listener sebelumnya jika ada
            if (unsubscribeGames) unsubscribeGames();

            unsubscribeGames = onSnapshot(q, snapshot => {
                allGamesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGameList(allGamesCache);
                
                if (document.getElementById('tab-bulk').classList.contains('active')) {
                    renderBulkActionsList();
                }
                if (document.getElementById('tab-stats').classList.contains('active')) {
                    renderStatistics();
                }
            }, error => console.error("Error loading games:", error));
        }

        function renderGameList(games) {
            const listBody = document.getElementById('game-list-body');
            listBody.innerHTML = '';
            if (games.length === 0) {
                listBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Belum ada game. Tambahkan satu!</td></tr>';
                return;
            }
            games.forEach(game => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${game.title}</td>
                    <td>${game.platform}</td>
                    <td>${game.location}</td>
                    <td class="${game.status === 'Dimainkan' ? 'status-played' : 'status-unplayed'}">${game.status}</td>
                `;
                listBody.appendChild(row);
            });
        }
        
        // === STATISTICS ===
        function renderStatistics() {
            const statsContainer = document.getElementById('stats-container');
            statsContainer.innerHTML = `
                <div class="chart-container"><canvas id="platform-chart"></canvas></div>
                <div class="chart-container"><canvas id="location-chart"></canvas></div>
                <div class="chart-container"><canvas id="status-chart"></canvas></div>
            `;
            if (allGamesCache.length === 0) {
                 statsContainer.innerHTML = '<p>Tidak ada data untuk ditampilkan pada statistik.</p>';
                return;
            }
            
            const processData = (key) => {
                return allGamesCache.reduce((acc, game) => {
                    acc[game[key]] = (acc[game[key]] || 0) + 1;
                    return acc;
                }, {});
            };

            createChart('platform-chart', 'Game per Platform', processData('platform'));
            createChart('location-chart', 'Game per Lokasi', processData('location'));
            createChart('status-chart', 'Status Game', processData('status'));
        }

        function createChart(canvasId, label, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (charts[canvasId]) {
                charts[canvasId].destroy();
            }
            charts[canvasId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: label,
                        data: Object.values(data),
                        backgroundColor: ['#03dac6', '#bb86fc', '#cf6679', '#f2e5a6', '#81c784', '#64b5f6'],
                        borderColor: '#1e1e1e',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#e0e0e0' } },
                        title: { display: true, text: label, color: '#e0e0e0', font: { size: 16 } }
                    }
                }
            });
        }

        // === BULK ACTIONS ===
        const filters = {
            platform: document.getElementById('filter-platform'),
            location: document.getElementById('filter-location'),
            status: document.getElementById('filter-status'),
        };
        Object.values(filters).forEach(filter => filter.addEventListener('change', renderBulkActionsList));
        
        function renderBulkActionsList() {
            const listBody = document.getElementById('bulk-game-list-body');
            document.getElementById('select-all-checkbox').checked = false;
            
            const filteredGames = allGamesCache.filter(game => {
                return (filters.platform.value === 'all' || game.platform === filters.platform.value) &&
                       (filters.location.value === 'all' || game.location === filters.location.value) &&
                       (filters.status.value === 'all' || game.status === filters.status.value);
            });

            listBody.innerHTML = '';
            if (filteredGames.length === 0) {
                 listBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Tidak ada game yang cocok dengan filter.</td></tr>';
                return;
            }
            filteredGames.forEach(game => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="game-checkbox" data-id="${game.id}"></td>
                    <td>${game.title}</td>
                    <td>${game.platform}</td>
                    <td>${game.location}</td>
                    <td class="${game.status === 'Dimainkan' ? 'status-played' : 'status-unplayed'}">${game.status}</td>
                `;
                listBody.appendChild(row);
            });
        }
        
        document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
            document.querySelectorAll('#bulk-game-list-body .game-checkbox').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        });

        document.getElementById('bulk-delete-btn').addEventListener('click', async () => {
            const selectedIds = Array.from(document.querySelectorAll('#bulk-game-list-body .game-checkbox:checked'))
                                     .map(cb => cb.dataset.id);

            if (selectedIds.length === 0) {
                alert('Pilih setidaknya satu game untuk dihapus.');
                return;
            }

            if (confirm(`Anda yakin ingin menghapus ${selectedIds.length} game terpilih? Aksi ini tidak dapat dibatalkan.`)) {
                try {
                    const batch = writeBatch(db);
                    selectedIds.forEach(id => {
                        const docRef = doc(db, 'users', currentUser.uid, 'games', id);
                        batch.delete(docRef);
                    });
                    await batch.commit();
                    console.log(`${selectedIds.length} games deleted.`);
                } catch (error) {
                    console.error("Error deleting games: ", error);
                    alert('Gagal menghapus game. Lihat konsol untuk detail.');
                }
            }
        });


        // === DATA MANAGEMENT ===
        document.getElementById('download-json-btn').addEventListener('click', () => {
            if (allGamesCache.length === 0) {
                alert('Tidak ada data untuk diunduh.');
                return;
            }
            const dataToDownload = allGamesCache.map(({id, ...rest}) => rest);
            const jsonString = JSON.stringify(dataToDownload, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `koleksi_game_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        
        const uploadInput = document.getElementById('upload-json-input');
        uploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm('PERINGATAN: Ini akan MENGGANTI seluruh koleksi game Anda dengan data dari file. Lanjutkan?')) {
                uploadInput.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const newGames = JSON.parse(e.target.result);
                    if (!Array.isArray(newGames)) throw new Error('JSON harus berupa array (array of objects).');

                    // Hapus data lama
                    const deleteBatch = writeBatch(db);
                    allGamesCache.forEach(game => deleteBatch.delete(doc(gamesCollectionRef, game.id)));
                    await deleteBatch.commit();
                    
                    console.log('Data lama dihapus. Memuat data baru...');

                    // Tambah data baru
                    const addBatch = writeBatch(db);
                    newGames.forEach(game => {
                        const newDocRef = doc(gamesCollectionRef); // Buat ref baru dengan ID acak
                        addBatch.set(newDocRef, game);
                    });
                    await addBatch.commit();
                    
                    alert('Data berhasil dimuat dari file JSON!');
                } catch (error) {
                    console.error('Error saat memuat JSON:', error);
                    alert('Gagal memuat data. Periksa konsol untuk detailnya.');
                } finally {
                    uploadInput.value = '';
                }
            };
            reader.readAsText(file);
        });

    </script>
</body>
</html>
