<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Koleksi Game</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js untuk Grafik Statistik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Menggunakan font Inter */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style untuk modal agar muncul di tengah */
        .modal-container {
            background-color: rgba(0, 0, 0, 0.75);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4f46e5;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4338ca;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="app">
        <!-- Konten aplikasi akan dirender di sini oleh JavaScript -->
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, writeBatch, onSnapshot, deleteDoc, updateDoc, setDoc, query } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- KONFIGURASI FIREBASE ---
        // PENTING: Untuk produksi, gunakan environment variables, jangan hardcode seperti ini.
        const firebaseConfig = {
            apiKey: "AIzaSyAzJTL179V9bT-DfefZq9gcG8Tz88VzLmQ",
            authDomain: "koleksi-game.firebaseapp.com",
            projectId: "koleksi-game",
            storageBucket: "koleksi-game.appspot.com",
            messagingSenderId: "222959670551",
            appId: "1:222959670551:web:048b1e2c4ef16b7bd31352",
            measurementId: "G-BYYCM7R4M8"
        };

        // --- INISIALISASI FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STATE APLIKASI ---
        let currentUser = null;
        let games = [];
        let activeTab = 'Daftar Game';
        let unsubscribeGames = null; // Untuk listener onSnapshot
        let activeCharts = []; // Untuk menyimpan instance chart

        // --- DATA KONSTAN ---
        const PLATFORMS = ["Steam", "Epic Games", "GOG", "PCSX", "Lainnya"];
        const LOCATIONS = ["Internal SSD", "HDD Eksternal 2TB", "HDD Eksternal 4TB", "Cloud"];
        const STATUSES = ["Dimainkan", "Belum Dimainkan", "Selesai", "Ditinggalkan"];
        
        const appContainer = document.getElementById('app');

        // --- FUNGSI RENDER UTAMA ---
        const render = () => {
            appContainer.innerHTML = ''; // Kosongkan konten sebelum render ulang
            if (!currentUser) {
                appContainer.innerHTML = renderLoginScreen();
                document.getElementById('login-btn').addEventListener('click', handleLogin);
            } else {
                appContainer.innerHTML = renderDashboard(currentUser);
                attachDashboardListeners();
                renderActiveTabContent();
            }
        };

        // --- TEMPLATE & RENDER KOMPONEN ---

        const renderLoginScreen = () => `
            <div class="flex flex-col items-center justify-center h-screen bg-gray-900">
                <div class="text-center p-8 bg-gray-800 rounded-2xl shadow-2xl max-w-md mx-4">
                    <h1 class="text-4xl font-bold text-white mb-2">Dasbor Koleksi Game</h1>
                    <p class="text-gray-400 mb-8">Kelola dan lacak semua game favorit Anda di satu tempat.</p>
                    <button id="login-btn" class="flex w-full items-center justify-center px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-transform transform hover:scale-105 duration-300">
                        <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039L38.804 9.81C34.553 5.822 29.588 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"></path><path fill="#FF3D00" d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.843-5.368C34.553 5.822 29.588 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"></path><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z"></path><path fill="#1976D2" d="M43.611 20.083H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.012 35.238 44 30.025 44 24c0-1.341-.138-2.65-.389-3.917z"></path></svg>
                        Masuk dengan Google
                    </button>
                </div>
            </div>
        `;

        const renderDashboard = (user) => `
            <div class="p-4 sm:p-6 lg:p-8">
                <header class="flex flex-col sm:flex-row justify-between items-center mb-8">
                    <div class="flex items-center mb-4 sm:mb-0">
                        <img src="${user.photoURL}" alt="${user.displayName}" class="w-12 h-12 rounded-full mr-4 border-2 border-indigo-500"/>
                        <div>
                            <h1 class="text-2xl font-bold text-white">${user.displayName}'s</h1>
                            <h2 class="text-xl font-semibold text-gray-300">Koleksi Game</h2>
                        </div>
                    </div>
                    <button id="logout-btn" class="flex items-center px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        Logout
                    </button>
                </header>

                <nav class="mb-8">
                    <div id="tabs-container" class="flex space-x-2 sm:space-x-4 border-b border-gray-700 overflow-x-auto">
                        ${['Daftar Game', 'Statistik', 'Aksi Masal', 'Manajemen Data'].map(tab => `
                            <button data-tab="${tab}" class="tab-btn px-3 sm:px-4 py-3 font-semibold text-sm sm:text-base transition-colors duration-300 whitespace-nowrap ${activeTab === tab ? 'border-b-2 border-indigo-500 text-white' : 'text-gray-400 hover:text-white'}">
                                ${tab}
                            </button>
                        `).join('')}
                    </div>
                </nav>

                <main id="tab-content" class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg min-h-[60vh]">
                    <!-- Konten tab akan dirender di sini -->
                </main>
            </div>
            <div id="modal-placeholder"></div>
        `;

        const renderGameList = () => {
            const statusColorMap = {
                'Dimainkan': 'bg-blue-500/30 text-blue-300',
                'Belum Dimainkan': 'bg-yellow-500/30 text-yellow-300',
                'Selesai': 'bg-green-500/30 text-green-300',
                'Ditinggalkan': 'bg-red-500/30 text-red-300'
            };
            
            let content = `
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-white">Daftar Game (${games.length})</h3>
                    <button id="add-game-btn" class="flex items-center px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition-all duration-300 transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        Tambah Game
                    </button>
                </div>
            `;

            if (games.length === 0) {
                content += `
                    <div class="text-center py-16">
                        <p class="text-gray-400">Koleksi game Anda masih kosong.</p>
                        <p class="text-gray-500">Klik "Tambah Game" untuk memulai.</p>
                    </div>
                `;
            } else {
                content += `
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="border-b border-gray-600 text-gray-400">
                                <tr>
                                    <th class="p-4">Nama Game</th>
                                    <th class="p-4 hidden sm:table-cell">Platform</th>
                                    <th class="p-4 hidden md:table-cell">Lokasi</th>
                                    <th class="p-4">Status</th>
                                    <th class="p-4 text-right">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${games.map(game => `
                                    <tr key="${game.id}" class="border-b border-gray-700 hover:bg-gray-700/50">
                                        <td class="p-4 font-semibold text-white">${game.name}</td>
                                        <td class="p-4 hidden sm:table-cell">${game.platform}</td>
                                        <td class="p-4 hidden md:table-cell">${game.location}</td>
                                        <td class="p-4">
                                            <span class="px-2 py-1 text-xs font-bold rounded-full ${statusColorMap[game.status] || 'bg-gray-500/30 text-gray-300'}">
                                                ${game.status}
                                            </span>
                                        </td>
                                        <td class="p-4 text-right whitespace-nowrap">
                                            <button class="edit-game-btn p-2 text-gray-400 hover:text-white" data-id="${game.id}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                                            <button class="delete-game-btn p-2 text-gray-400 hover:text-red-500" data-id="${game.id}"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            return content;
        };

        const renderModal = (game = null) => {
            const isEditing = game !== null;
            const modalHTML = `
                <div id="game-modal" class="modal-container fixed inset-0 flex justify-center items-center z-50 p-4">
                    <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md">
                        <h2 class="text-2xl font-bold mb-6 text-white">${isEditing ? 'Edit Game' : 'Tambah Game Baru'}</h2>
                        <form id="game-form">
                            <input type="hidden" name="id" value="${isEditing ? game.id : ''}">
                            <div class="mb-4">
                                <label class="block text-gray-400 mb-2" for="name">Nama Game</label>
                                <input type="text" id="name" name="name" value="${isEditing ? game.name : ''}" class="w-full p-2 bg-gray-700 rounded border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500" required />
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-400 mb-2" for="platform">Platform</label>
                                <select id="platform" name="platform" class="w-full p-2 bg-gray-700 rounded border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    ${PLATFORMS.map(p => `<option value="${p}" ${isEditing && game.platform === p ? 'selected' : ''}>${p}</option>`).join('')}
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-400 mb-2" for="location">Lokasi</label>
                                <select id="location" name="location" class="w-full p-2 bg-gray-700 rounded border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    ${LOCATIONS.map(l => `<option value="${l}" ${isEditing && game.location === l ? 'selected' : ''}>${l}</option>`).join('')}
                                </select>
                            </div>
                            <div class="mb-6">
                                <label class="block text-gray-400 mb-2" for="status">Status</label>
                                <select id="status" name="status" class="w-full p-2 bg-gray-700 rounded border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    ${STATUSES.map(s => `<option value="${s}" ${isEditing && game.status === s ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                            <div class="flex justify-end space-x-4">
                                <button type="button" id="cancel-modal-btn" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-500">Batal</button>
                                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-bold rounded hover:bg-indigo-700">${isEditing ? 'Simpan Perubahan' : 'Tambah'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.getElementById('modal-placeholder').innerHTML = modalHTML;
            document.getElementById('game-form').addEventListener('submit', handleSaveGame);
            document.getElementById('cancel-modal-btn').addEventListener('click', () => {
                document.getElementById('modal-placeholder').innerHTML = '';
            });
        };
        
        const renderStatistics = () => {
            if (games.length === 0) {
                return `<div class="text-center py-16 text-gray-400">Tidak ada data untuk ditampilkan. Tambahkan beberapa game terlebih dahulu.</div>`;
            }

            return `
                <div>
                    <h3 class="text-2xl font-bold text-white mb-8">Statistik Koleksi</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-gray-900/50 p-6 rounded-lg">
                            <h4 class="text-lg font-semibold text-white mb-4">Game per Platform</h4>
                            <canvas id="platformChart"></canvas>
                        </div>
                        <div class="bg-gray-900/50 p-6 rounded-lg">
                            <h4 class="text-lg font-semibold text-white mb-4">Game per Status</h4>
                            <canvas id="statusChart"></canvas>
                        </div>
                        <div class="bg-gray-900/50 p-6 rounded-lg lg:col-span-2">
                            <h4 class="text-lg font-semibold text-white mb-4">Game per Lokasi Penyimpanan</h4>
                            <canvas id="locationChart"></canvas>
                        </div>
                    </div>
                </div>
            `;
        };

        // --- LOGIKA APLIKASI ---

        const handleLogin = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error saat login:", error);
                alert("Gagal login dengan Google.");
            }
        };

        const handleLogout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error saat logout:", error);
            }
        };

        const handleSaveGame = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const gameData = Object.fromEntries(formData.entries());
            const gameId = gameData.id;

            if (!gameData.name) {
                alert("Nama game tidak boleh kosong!");
                return;
            }
            
            try {
                if (gameId) { // Editing
                    const gameDocRef = doc(db, 'users', currentUser.uid, 'games', gameId);
                    delete gameData.id; // Hapus id dari data yang akan diupdate
                    await updateDoc(gameDocRef, gameData);
                } else { // Adding
                    const gamesCollectionRef = collection(db, 'users', currentUser.uid, 'games');
                    delete gameData.id; // Hapus id kosong
                    await addDoc(gamesCollectionRef, gameData);
                }
                document.getElementById('modal-placeholder').innerHTML = ''; // Tutup modal
            } catch (error) {
                console.error("Error saving game:", error);
                alert("Gagal menyimpan game.");
            }
        };

        const handleDeleteGame = async (gameId) => {
            if (confirm("Apakah Anda yakin ingin menghapus game ini?")) {
                try {
                    const gameDocRef = doc(db, 'users', currentUser.uid, 'games', gameId);
                    await deleteDoc(gameDocRef);
                } catch (error) {
                    console.error("Error deleting game:", error);
                    alert("Gagal menghapus game.");
                }
            }
        };
        
        const createCharts = () => {
            // Hancurkan chart lama jika ada
            activeCharts.forEach(chart => chart.destroy());
            activeCharts = [];

            if (games.length === 0) return;

            const chartOptions = {
                plugins: {
                    legend: { labels: { color: '#d1d5db' } }
                }
            };
            const barChartOptions = {
                ...chartOptions,
                scales: {
                    y: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } },
                    x: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } }
                }
            };
            const chartColors = ['#6366f1', '#34d399', '#f59e0b', '#ef4444', '#a855f7'];

            // Data per Platform
            const platformCtx = document.getElementById('platformChart')?.getContext('2d');
            if (platformCtx) {
                const platformCounts = games.reduce((acc, game) => {
                    acc[game.platform] = (acc[game.platform] || 0) + 1;
                    return acc;
                }, {});
                activeCharts.push(new Chart(platformCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(platformCounts),
                        datasets: [{ data: Object.values(platformCounts), backgroundColor: chartColors }]
                    },
                    options: chartOptions
                }));
            }
            
            // Data per Status
            const statusCtx = document.getElementById('statusChart')?.getContext('2d');
            if (statusCtx) {
                const statusCounts = games.reduce((acc, game) => {
                    acc[game.status] = (acc[game.status] || 0) + 1;
                    return acc;
                }, {});
                activeCharts.push(new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statusCounts),
                        datasets: [{ data: Object.values(statusCounts), backgroundColor: chartColors }]
                    },
                    options: chartOptions
                }));
            }

            // Data per Lokasi
            const locationCtx = document.getElementById('locationChart')?.getContext('2d');
            if(locationCtx) {
                const locationCounts = games.reduce((acc, game) => {
                    acc[game.location] = (acc[game.location] || 0) + 1;
                    return acc;
                }, {});
                activeCharts.push(new Chart(locationCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(locationCounts),
                        datasets: [{ label: 'Jumlah Game', data: Object.values(locationCounts), backgroundColor: '#6366f1' }]
                    },
                    options: barChartOptions
                }));
            }
        };

        // --- EVENT LISTENERS ---
        
        const attachDashboardListeners = () => {
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('tabs-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('tab-btn')) {
                    activeTab = e.target.dataset.tab;
                    // Update tampilan tombol tab
                    document.querySelectorAll('.tab-btn').forEach(btn => {
                        btn.classList.toggle('border-b-2', btn === e.target);
                        btn.classList.toggle('border-indigo-500', btn === e.target);
                        btn.classList.toggle('text-white', btn === e.target);
                        btn.classList.toggle('text-gray-400', btn !== e.target);
                    });
                    renderActiveTabContent();
                }
            });
        };

        const attachGameListListeners = () => {
            document.getElementById('add-game-btn')?.addEventListener('click', () => renderModal());
            document.getElementById('tab-content').addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-game-btn');
                const deleteBtn = e.target.closest('.delete-game-btn');
                if (editBtn) {
                    const game = games.find(g => g.id === editBtn.dataset.id);
                    renderModal(game);
                }
                if (deleteBtn) {
                    handleDeleteGame(deleteBtn.dataset.id);
                }
            });
        };
        
        const renderActiveTabContent = () => {
            const contentContainer = document.getElementById('tab-content');
            if (!contentContainer) return;
            
            contentContainer.innerHTML = '<div class="flex justify-center items-center h-full text-gray-400">Memuat...</div>';

            if (activeTab === 'Daftar Game') {
                contentContainer.innerHTML = renderGameList();
                attachGameListListeners();
            } else if (activeTab === 'Statistik') {
                contentContainer.innerHTML = renderStatistics();
                // Tunggu sebentar agar canvas dirender sebelum membuat chart
                setTimeout(createCharts, 50);
            } else if (activeTab === 'Aksi Masal') {
                contentContainer.innerHTML = `<div class="text-center py-16 text-gray-400">Fitur Aksi Masal sedang dalam pengembangan.</div>`;
            } else if (activeTab === 'Manajemen Data') {
                contentContainer.innerHTML = `<div class="text-center py-16 text-gray-400">Fitur Manajemen Data sedang dalam pengembangan.</div>`;
            }
        };

        // --- INISIALISASI APLIKASI ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const gamesCollectionRef = collection(db, 'users', user.uid, 'games');
                // Hentikan listener lama jika ada
                if (unsubscribeGames) unsubscribeGames();
                // Buat listener baru
                unsubscribeGames = onSnapshot(query(gamesCollectionRef), (snapshot) => {
                    games = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Render ulang hanya jika dashboard sudah ditampilkan
                    if(document.getElementById('tab-content')) {
                        renderActiveTabContent();
                    } else {
                        render();
                    }
                }, (error) => {
                    console.error("Error fetching games:", error);
                });
            } else {
                currentUser = null;
                games = [];
                if (unsubscribeGames) unsubscribeGames();
            }
            render();
        });

    </script>
</body>
</html>
