<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Koleksi Game</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Poppins', sans-serif;
        }
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .main-dashboard {
            display: none; /* Disembunyikan secara default */
        }
        .nav-link {
            cursor: pointer;
        }
        .stat-card {
            height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .form-label {
            font-weight: 500;
        }
        .material-symbols-outlined {
            vertical-align: middle;
        }
    </style>
</head>
<body>

    <div id="login-screen" class="login-container text-center">
        <h1 class="mb-4">ðŸŽ® Dashboard Koleksi Game</h1>
        <p class="text-muted mb-4">Silakan login untuk mengelola koleksi game Anda.</p>
        <button id="login-btn" class="btn btn-primary btn-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-google me-2" viewBox="0 0 16 16">
                <path d="M15.545 6.558a9.42 9.42 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.689 7.689 0 0 1 5.352 2.082l-2.284 2.284A4.347 4.347 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.25C2.893 7.087 2.82 7.545 2.82 8s.073.913.256 1.484c.632 1.842 2.405 3.25 4.492 3.25 1.133 0 2.14-.37 2.932-1.012l.002-.002 2.284 2.284A7.952 7.952 0 0 1 8 16c-2.158 0-3.978-.708-5.352-1.89C1.226 12.783.5 10.592.5 8s.726-4.783 2.148-6.11A7.95 7.95 0 0 1 8 0c2.434 0 4.492.87 5.885 2.384l-2.284 2.284A4.347 4.347 0 0 0 8 4.834c-1.133 0-2.14.37-2.932 1.012l-.002.002C4.13 6.913 3.5 8.958 3.5 10.5c0 1.542.63 3.587 1.58 4.492l.002.002a4.347 4.347 0 0 0 2.92 1.012c1.842 0 3.25-.632 4.492-2.405.958-.857 1.58-2.434 1.58-4.492a9.42 9.42 0 0 1-.139-1.626H8V6.558h7.545z"/>
            </svg>
            Login dengan Google
        </button>
    </div>

    <div id="main-dashboard" class="main-dashboard">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">ðŸŽ® Koleksi Game</a>
                <div class="d-flex align-items-center">
                    <span id="user-display" class="navbar-text me-3"></span>
                    <button id="logout-btn" class="btn btn-outline-danger">Logout</button>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-pane" type="button" role="tab">
                        <span class="material-symbols-outlined">list</span> Daftar Game
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats-pane" type="button" role="tab">
                        <span class="material-symbols-outlined">pie_chart</span> Statistik
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="bulk-tab" data-bs-toggle="tab" data-bs-target="#bulk-pane" type="button" role="tab">
                        <span class="material-symbols-outlined">checklist</span> Aksi Masal
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data-pane" type="button" role="tab">
                        <span class="material-symbols-outlined">database</span> Manajemen Data
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="list-pane" role="tabpanel" tabindex="0">
                    <div class="card mt-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Koleksi Game Saya</h5>
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#game-modal" id="add-game-btn">
                                <span class="material-symbols-outlined">add</span> Tambah Game
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Judul Game</th>
                                            <th>Platform</th>
                                            <th>Lokasi</th>
                                            <th>Status</th>
                                            <th>Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="game-list-body">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="stats-pane" role="tabpanel" tabindex="0">
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header text-center">Game per Platform</div>
                                <div class="card-body stat-card">
                                    <canvas id="platform-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                             <div class="card">
                                <div class="card-header text-center">Game per Lokasi</div>
                                <div class="card-body stat-card">
                                    <canvas id="location-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                             <div class="card">
                                <div class="card-header text-center">Game per Status</div>
                                <div class="card-body stat-card">
                                    <canvas id="status-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="bulk-pane" role="tabpanel" tabindex="0">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5>Filter dan Aksi Masal</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 mb-3 p-3 bg-light rounded border">
                                <div class="col-md-3">
                                    <label for="filter-platform" class="form-label">Platform</label>
                                    <select id="filter-platform" class="form-select">
                                        <option value="">Semua</option>
                                        <option>Steam</option><option>Epic</option><option>GOG</option><option>PCSX</option><option>Crack</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="filter-location" class="form-label">Lokasi</label>
                                    <select id="filter-location" class="form-select">
                                        <option value="">Semua</option>
                                        <option>HDD Eksternal 2TB</option><option>HDD Eksternal 4TB</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="filter-status" class="form-label">Status</label>
                                    <select id="filter-status" class="form-select">
                                        <option value="">Semua</option>
                                        <option>Dimainkan</option><option>Belum dimainkan</option>
                                    </select>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button id="reset-filter-btn" class="btn btn-secondary w-100">Reset Filter</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <button id="bulk-delete-btn" class="btn btn-danger">
                                    <span class="material-symbols-outlined">delete_sweep</span> Hapus yang Dipilih
                                </button>
                                <button id="bulk-edit-btn" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#bulk-edit-modal">
                                    <span class="material-symbols-outlined">edit</span> Edit yang Dipilih
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th><input type="checkbox" id="select-all-checkbox"></th>
                                            <th>Judul Game</th>
                                            <th>Platform</th>
                                            <th>Lokasi</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bulk-list-body">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="data-pane" role="tabpanel" tabindex="0">
                     <div class="row mt-3 g-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5>Unduh Data (Backup)</h5>
                                </div>
                                <div class="card-body text-center">
                                    <p>Simpan seluruh koleksi game Anda sebagai file JSON.</p>
                                    <button id="download-json-btn" class="btn btn-primary">
                                        <span class="material-symbols-outlined">download</span> Unduh JSON
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5>Muat Data (Restore)</h5>
                                </div>
                                <div class="card-body text-center">
                                    <p>Ganti data saat ini dengan data dari file JSON. <strong>Aksi ini tidak dapat dibatalkan.</strong></p>
                                    <input type="file" id="upload-json-input" class="form-control mb-3" accept=".json">
                                    <button id="upload-json-btn" class="btn btn-warning">
                                        <span class="material-symbols-outlined">upload</span> Muat JSON ke Firebase
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="game-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="game-modal-title">Tambah Game Baru</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="game-form">
                        <input type="hidden" id="game-id">
                        <div class="mb-3">
                            <label for="game-title" class="form-label">Judul Game</label>
                            <input type="text" class="form-control" id="game-title" required>
                        </div>
                        <div class="mb-3">
                            <label for="game-platform" class="form-label">Platform</label>
                            <select class="form-select" id="game-platform" required>
                                <option>Steam</option>
                                <option>Epic</option>
                                <option>GOG</option>
                                <option>PCSX</option>
                                <option>Crack</option>
                            </select>
                        </div>
                         <div class="mb-3">
                            <label for="game-location" class="form-label">Lokasi Penyimpanan</label>
                            <select class="form-select" id="game-location" required>
                                <option>HDD Eksternal 2TB</option>
                                <option>HDD Eksternal 4TB</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="game-status" class="form-label">Status</label>
                            <select class="form-select" id="game-status" required>
                                <option>Belum dimainkan</option>
                                <option>Dimainkan</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="save-game-btn">Simpan</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="bulk-edit-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Game yang Dipilih</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Pilih properti yang ingin diubah untuk semua game yang dipilih.</p>
                    <div class="mb-3">
                        <label for="bulk-edit-platform" class="form-label">Ubah Platform ke:</label>
                        <select id="bulk-edit-platform" class="form-select">
                            <option value="">-- Jangan Ubah --</option>
                            <option>Steam</option><option>Epic</option><option>GOG</option><option>PCSX</option><option>Crack</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="bulk-edit-location" class="form-label">Ubah Lokasi ke:</label>
                        <select id="bulk-edit-location" class="form-select">
                            <option value="">-- Jangan Ubah --</option>
                            <option>HDD Eksternal 2TB</option><option>HDD Eksternal 4TB</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="bulk-edit-status" class="form-label">Ubah Status ke:</label>
                        <select id="bulk-edit-status" class="form-select">
                            <option value="">-- Jangan Ubah --</option>
                            <option>Dimainkan</option><option>Belum dimainkan</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="apply-bulk-edit-btn">Terapkan Perubahan</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Konfigurasi Firebase Anda
        const firebaseConfig = {
            apiKey: "AIzaSyAzJTL179V9bT-DfefZq9gcG8Tz88VzLmQ",
            authDomain: "koleksi-game.firebaseapp.com",
            projectId: "koleksi-game",
            storageBucket: "koleksi-game.appspot.com", // pastikan domain benar
            messagingSenderId: "222959670551",
            appId: "1:222959670551:web:048b1e2c4ef16b7bd31352",
            measurementId: "G-BYYCM7R4M8"
        };

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const provider = new firebase.auth.GoogleAuthProvider();

        // Variabel Global
        let currentUser = null;
        let gameData = {};
        let platformChart, locationChart, statusChart;
        const gameModal = new bootstrap.Modal(document.getElementById('game-modal'));
        const bulkEditModal = new bootstrap.Modal(document.getElementById('bulk-edit-modal'));

        // Elemen DOM
        const loginScreen = document.getElementById('login-screen');
        const mainDashboard = document.getElementById('main-dashboard');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userDisplay = document.getElementById('user-display');
        
        // Pemantau status Autentikasi
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                loginScreen.style.display = 'none';
                mainDashboard.style.display = 'block';
                userDisplay.textContent = `Hello, ${user.displayName}`;
                loadGames();
            } else {
                currentUser = null;
                loginScreen.style.display = 'flex';
                mainDashboard.style.display = 'none';
                gameData = {};
                renderGameList();
                renderBulkList();
            }
        });

        // Fungsi Login & Logout
        loginBtn.addEventListener('click', () => auth.signInWithPopup(provider));
        logoutBtn.addEventListener('click', () => auth.signOut());

        // Memuat data game dari Firebase
        function loadGames() {
            if (!currentUser) return;
            const gamesRef = database.ref('games/' + currentUser.uid);
            gamesRef.on('value', (snapshot) => {
                gameData = snapshot.val() || {};
                applyFilters(); // Ini akan memanggil render dan update statistik
            });
        }
        
        function renderGameList() {
            const gameListBody = document.getElementById('game-list-body');
            gameListBody.innerHTML = '';
            if (Object.keys(gameData).length === 0) {
                 gameListBody.innerHTML = '<tr><td colspan="5" class="text-center">Belum ada game. Silakan tambahkan.</td></tr>';
                 return;
            }

            for (const gameId in gameData) {
                const game = gameData[gameId];
                const row = `
                    <tr>
                        <td>${game.title}</td>
                        <td>${game.platform}</td>
                        <td>${game.location}</td>
                        <td><span class="badge bg-${game.status === 'Dimainkan' ? 'success' : 'secondary'}">${game.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning edit-btn" data-id="${gameId}">
                                <span class="material-symbols-outlined" style="font-size: 1rem;">edit</span>
                            </button>
                            <button class="btn btn-sm btn-danger delete-btn" data-id="${gameId}">
                                <span class="material-symbols-outlined" style="font-size: 1rem;">delete</span>
                            </button>
                        </td>
                    </tr>`;
                gameListBody.innerHTML += row;
            }
        }

        // CRUD Actions
        document.getElementById('save-game-btn').addEventListener('click', () => {
            const id = document.getElementById('game-id').value;
            const title = document.getElementById('game-title').value.trim();
            const platform = document.getElementById('game-platform').value;
            const location = document.getElementById('game-location').value;
            const status = document.getElementById('game-status').value;

            if (!title) {
                alert('Judul game tidak boleh kosong!');
                return;
            }
            
            const game = { title, platform, location, status };
            const gamesRef = database.ref('games/' + currentUser.uid);

            if (id) { // Edit
                gamesRef.child(id).update(game)
                    .then(() => gameModal.hide())
                    .catch(error => alert(error.message));
            } else { // Tambah
                gamesRef.push(game)
                    .then(() => gameModal.hide())
                    .catch(error => alert(error.message));
            }
        });

        document.getElementById('list-pane').addEventListener('click', e => {
            if (e.target.closest('.edit-btn')) {
                const gameId = e.target.closest('.edit-btn').dataset.id;
                const game = gameData[gameId];
                document.getElementById('game-modal-title').textContent = 'Edit Game';
                document.getElementById('game-id').value = gameId;
                document.getElementById('game-title').value = game.title;
                document.getElementById('game-platform').value = game.platform;
                document.getElementById('game-location').value = game.location;
                document.getElementById('game-status').value = game.status;
                gameModal.show();
            }
            if (e.target.closest('.delete-btn')) {
                const gameId = e.target.closest('.delete-btn').dataset.id;
                if (confirm(`Apakah Anda yakin ingin menghapus game "${gameData[gameId].title}"?`)) {
                    database.ref('games/' + currentUser.uid + '/' + gameId).remove();
                }
            }
        });

        document.getElementById('add-game-btn').addEventListener('click', () => {
            document.getElementById('game-modal-title').textContent = 'Tambah Game Baru';
            document.getElementById('game-form').reset();
            document.getElementById('game-id').value = '';
        });

        // Tab Statistik
        function updateStatistics() {
            const stats = {
                platform: {},
                location: {},
                status: {}
            };

            for (const id in gameData) {
                const game = gameData[id];
                stats.platform[game.platform] = (stats.platform[game.platform] || 0) + 1;
                stats.location[game.location] = (stats.location[game.location] || 0) + 1;
                stats.status[game.status] = (stats.status[game.status] || 0) + 1;
            }

            createOrUpdateChart(platformChart, 'platform-chart', 'pie', stats.platform, 'Game per Platform');
            createOrUpdateChart(locationChart, 'location-chart', 'doughnut', stats.location, 'Game per Lokasi');
            createOrUpdateChart(statusChart, 'status-chart', 'pie', stats.status, 'Game per Status');
        }

        function createOrUpdateChart(chartInstance, canvasId, type, data, label) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (window[canvasId]) {
                 window[canvasId].destroy();
            }
            window[canvasId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: label,
                        data: Object.values(data),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 
                            'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 
                            'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'
                        ],
                        borderColor: 'rgba(255, 255, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
        
        document.getElementById('stats-tab').addEventListener('click', updateStatistics);
        
        // Tab Aksi Masal
        let filteredGameData = {};

        function applyFilters() {
            const platform = document.getElementById('filter-platform').value;
            const location = document.getElementById('filter-location').value;
            const status = document.getElementById('filter-status').value;

            filteredGameData = Object.entries(gameData).filter(([id, game]) => {
                const platformMatch = !platform || game.platform === platform;
                const locationMatch = !location || game.location === location;
                const statusMatch = !status || game.status === status;
                return platformMatch && locationMatch && statusMatch;
            }).reduce((obj, [id, game]) => {
                obj[id] = game;
                return obj;
            }, {});
            
            // Panggil semua fungsi render setelah filter
            renderGameList();
            renderBulkList();
            updateStatistics(); // Statistik juga mengikuti data utama, bukan filter
        }

        function renderBulkList() {
            const bulkListBody = document.getElementById('bulk-list-body');
            bulkListBody.innerHTML = '';
             if (Object.keys(filteredGameData).length === 0) {
                 bulkListBody.innerHTML = '<tr><td colspan="5" class="text-center">Tidak ada data yang cocok dengan filter.</td></tr>';
                 return;
            }
            for (const gameId in filteredGameData) {
                const game = filteredGameData[gameId];
                const row = `
                    <tr>
                        <td><input type="checkbox" class="bulk-checkbox" data-id="${gameId}"></td>
                        <td>${game.title}</td>
                        <td>${game.platform}</td>
                        <td>${game.location}</td>
                        <td>${game.status}</td>
                    </tr>`;
                bulkListBody.innerHTML += row;
            }
        }
        
        // Event listener untuk filter
        ['filter-platform', 'filter-location', 'filter-status'].forEach(id => {
            document.getElementById(id).addEventListener('change', applyFilters);
        });

        document.getElementById('reset-filter-btn').addEventListener('click', () => {
            document.getElementById('filter-platform').value = '';
            document.getElementById('filter-location').value = '';
            document.getElementById('filter-status').value = '';
            applyFilters();
        });
        
        // Select All Checkbox
        document.getElementById('select-all-checkbox').addEventListener('change', function() {
            document.querySelectorAll('.bulk-checkbox').forEach(cb => {
                cb.checked = this.checked;
            });
        });

        function getSelectedGameIds() {
            return Array.from(document.querySelectorAll('.bulk-checkbox:checked')).map(cb => cb.dataset.id);
        }

        document.getElementById('bulk-delete-btn').addEventListener('click', () => {
            const selectedIds = getSelectedGameIds();
            if (selectedIds.length === 0) {
                alert('Pilih setidaknya satu game untuk dihapus.');
                return;
            }
            if (confirm(`Anda yakin ingin menghapus ${selectedIds.length} game yang dipilih?`)) {
                const updates = {};
                selectedIds.forEach(id => {
                    updates['/games/' + currentUser.uid + '/' + id] = null;
                });
                database.ref().update(updates);
            }
        });
        
        document.getElementById('apply-bulk-edit-btn').addEventListener('click', () => {
             const selectedIds = getSelectedGameIds();
             if (selectedIds.length === 0) {
                alert('Pilih setidaknya satu game untuk diedit.');
                return;
            }

            const newPlatform = document.getElementById('bulk-edit-platform').value;
            const newLocation = document.getElementById('bulk-edit-location').value;
            const newStatus = document.getElementById('bulk-edit-status').value;
            
            if (!newPlatform && !newLocation && !newStatus) {
                alert('Pilih setidaknya satu properti untuk diubah.');
                return;
            }

            const updates = {};
            selectedIds.forEach(id => {
                if (newPlatform) updates[`/games/${currentUser.uid}/${id}/platform`] = newPlatform;
                if (newLocation) updates[`/games/${currentUser.uid}/${id}/location`] = newLocation;
                if (newStatus) updates[`/games/${currentUser.uid}/${id}/status`] = newStatus;
            });

            database.ref().update(updates)
                .then(() => {
                    bulkEditModal.hide();
                    alert(`${selectedIds.length} game berhasil diupdate.`);
                })
                .catch(err => alert('Gagal mengupdate: ' + err.message));
        });

        // Tab Manajemen Data
        document.getElementById('download-json-btn').addEventListener('click', () => {
            if (Object.keys(gameData).length === 0) {
                alert('Tidak ada data untuk diunduh.');
                return;
            }
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(gameData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "koleksi_game_backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        });

        document.getElementById('upload-json-btn').addEventListener('click', () => {
            const fileInput = document.getElementById('upload-json-input');
            if (fileInput.files.length === 0) {
                alert('Silakan pilih file JSON terlebih dahulu.');
                return;
            }
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(event) {
                try {
                    const newGameData = JSON.parse(event.target.result);
                    if (confirm("Anda yakin ingin MENGGANTI seluruh data koleksi game Anda dengan data dari file ini? Aksi ini tidak bisa dibatalkan.")) {
                        database.ref('games/' + currentUser.uid).set(newGameData)
                            .then(() => alert('Data berhasil dimuat dari JSON!'))
                            .catch(error => alert('Gagal memuat data: ' + error.message));
                    }
                } catch (e) {
                    alert('Error: File JSON tidak valid. ' + e.message);
                }
            };
            reader.readAsText(file);
        });

    </script>

</body>
</html>
